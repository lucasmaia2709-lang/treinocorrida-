<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExpliQ - Plataforma Completa</title>
    
    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #5E5CE6; --dark: #1C1C1E; --bg: #F2F2F7; --input-bg: #F9FAFB;
            --gray: #8E8E93; --green: #34C759; --white: #FFFFFF; --red: #FF3B30; --orange: #FF9500;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--dark); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Utilitários */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: none; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .screen.white-bg { background-color: var(--white); }
        .hidden { display: none !important; }

        /* UI Elements */
        .input-group { margin-bottom: 20px; text-align: left; }
        .label { display: block; font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; margin-bottom: 8px; margin-left: 4px; }
        .input { width: 100%; padding: 16px 20px; border-radius: 16px; border: 1px solid transparent; background-color: var(--input-bg); font-size: 14px; color: var(--dark); font-weight: 500; font-family: inherit; outline: none; transition: 0.3s; }
        .input:focus { background-color: var(--white); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(94, 92, 230, 0.15); }

        .btn { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--primary); color: var(--white); box-shadow: 0 4px 20px rgba(94, 92, 230, 0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-text { background: none; color: var(--primary); text-transform: none; padding: 10px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 14px; }
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: none; cursor: pointer; background: #F2F2F7; color: var(--dark); transition: 0.2s; }
        .btn-icon.active { background: var(--primary); color: white; }

        .card { background: var(--white); padding: 24px; border-radius: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .quote-card { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-left: 4px solid var(--primary); padding: 20px; border-radius: 16px; margin-bottom: 20px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .quote-icon { position: absolute; top: -10px; right: 20px; font-size: 40px; color: rgba(94, 92, 230, 0.1); }

        /* Menu */
        .nav-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--white); padding: 15px 30px 30px; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 40px rgba(0,0,0,0.05); display: flex; justify-content: space-between; z-index: 100; }
        .nav-item { background: none; border: none; color: #CCC; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 10px; font-weight: 700; }
        .nav-item.active { color: var(--primary); }

        /* Treinos */
        .timeline { position: relative; padding-left: 20px; }
        .line { position: absolute; left: 34px; top: 10px; bottom: 0; width: 2px; background: #E5E5E5; z-index: 0; }
        .workout { display: flex; align-items: center; margin-bottom: 20px; position: relative; z-index: 1; }
        .w-icon { width: 30px; height: 30px; border-radius: 50%; background: var(--white); border: 3px solid #E5E5E5; color: #E5E5E5; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; margin-right: 15px; flex-shrink: 0; }
        .workout.active .w-icon { border-color: var(--primary); color: var(--primary); background: var(--white); }
        .workout.done .w-icon { background: var(--green); border-color: var(--bg); color: var(--white); }
        .w-card { flex: 1; background: var(--white); padding: 16px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* Logout & Modals */
        .btn-logout-header { width: 40px; height: 40px; border-radius: 50%; background: var(--white); color: var(--red); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-card { background: white; width: 90%; max-width: 350px; border-radius: 24px; padding: 30px; transform: translateY(20px); transition: transform 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.active .modal-card { transform: translateY(0); }

        /* Upload Avatar */
        .avatar-container { width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto 20px; position: relative; border: 4px solid var(--bg); cursor: pointer; background: #EEE; display: flex; align-items: center; justify-content: center; color: #AAA; font-size: 30px; }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-container img.has-image { display: block; }
        .avatar-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 10px; text-align: center; padding: 4px; font-weight: 700; }
        .avatar-small { width: 45px; height: 45px; background: #EEE; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #AAA; }
        .avatar-small img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-small img.has-image { display: block; }

        .loader { display: none; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-right: 10px; }
        .btn-primary.loading .loader { display: block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="view-login" class="screen white-bg active">
        <button onclick="app.showAdminAuth()" style="position: absolute; top: 20px; right: 20px; border: none; background: none; color: #EEE; padding: 10px; cursor: pointer;"><i class="fa-solid fa-lock"></i></button>
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px; text-align: center;">
            <h1 style="font-size: 36px; margin-bottom: 10px; line-height: 1.1;">Bem-vindo<br>de volta!</h1>
            <p style="color: var(--gray); font-size: 14px; margin-bottom: 40px;">Entre para continuar seus treinos.</p>
            <form onsubmit="app.handleLogin(event)" style="width: 100%;">
                <div class="input-group"><label class="label">Email</label><input type="email" id="log-email" class="input" placeholder="seu@email.com" required></div>
                <div class="input-group"><label class="label">Senha</label><input type="password" id="log-pass" class="input" placeholder="******" required></div>
                <button type="submit" id="btn-login" class="btn btn-primary"><div class="loader"></div>ENTRAR</button>
            </form>
            <p id="login-error" style="color: var(--red); font-size: 12px; text-align: center; margin-top: 20px; display: none;">Email ou senha incorretos.</p>
            <div style="text-align: center; margin-top: 40px;"><p style="color: var(--gray); font-size: 14px;">Não tem uma conta? <button onclick="app.goToRegister()" class="btn-text" style="display:inline; padding:0;">Cadastre-se</button></p></div>
        </div>
    </div>

    <!-- 2. CADASTRO -->
    <div id="view-register" class="screen white-bg">
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px; text-align: center;">
            <button onclick="app.goToLogin()" style="position: absolute; top: 40px; left: 30px; background: none; border: none; color: var(--gray); padding: 0; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;"><i class="fa-solid fa-chevron-left"></i> Voltar</button>
            <h1 style="font-size: 36px; line-height: 1.1; margin-bottom: 40px; margin-top: 40px;">Criar Nova<br>Conta</h1>
            <form onsubmit="app.handleRegister(event)" style="width: 100%;">
                <div class="input-group"><label class="label">Nome Completo</label><input type="text" id="reg-name" class="input" placeholder="Ex: Ana Silva" required></div>
                <div class="input-group"><label class="label">Email</label><input type="email" id="reg-email" class="input" placeholder="ana@email.com" required></div>
                <div class="input-group"><label class="label">Senha</label><input type="password" id="reg-pass" class="input" placeholder="******" required></div>
                <button type="submit" id="btn-reg" class="btn btn-primary"><div class="loader"></div>CADASTRAR</button>
            </form>
        </div>
    </div>

    <!-- 3. PENDENTE -->
    <div id="view-pending" class="screen white-bg" style="align-items: center; justify-content: center; padding: 40px; text-align: center;">
        <div style="width: 80px; height: 80px; background: rgba(255,149,0,0.1); color: var(--orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 30px;"><i class="fa-solid fa-hourglass-start"></i></div>
        <h2 style="font-size: 24px; margin-bottom: 10px;">Cadastro em Análise</h2>
        <p style="color: var(--gray); font-size: 14px; line-height: 1.6; margin-bottom: 40px;">Seu treinador precisa liberar seu acesso. Aguarde e tente logar novamente mais tarde.</p>
        <button onclick="app.goToLogin()" class="btn-text">VOLTAR AO LOGIN</button>
    </div>

    <!-- 4. APP ALUNO -->
    <div id="view-app" class="screen">
        <div class="scroll-content" style="padding-bottom: 100px; flex: 1; overflow-y: auto;">
            
            <!-- Aba HOME -->
            <div id="tab-home" class="tab-content" style="padding: 24px;">
                <div class="header" style="padding: 20px 0 30px; display:flex; justify-content:space-between; align-items:center;">
                    <div><h2 style="font-size: 26px; margin: 0;">Olá!</h2><p id="user-name" style="color: var(--gray); font-size: 14px; margin: 0;">Atleta</p></div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="app.logout()" class="btn-logout-header" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></button>
                        <div onclick="app.showProfileSettings()" class="avatar-small" style="cursor: pointer; border: 2px solid var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <i class="fa-solid fa-user" id="user-icon-home"></i>
                            <img id="user-avatar-home" src="">
                        </div>
                    </div>
                </div>
                <!-- Prova -->
                <div class="card" style="background: var(--dark); color: var(--white);">
                    <div style="display: flex; justify-content: space-between;">
                        <div><span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700;">PRÓXIMO DESAFIO</span><h3 id="app-race" style="font-size: 22px; margin: 15px 0 5px;">...</h3><p id="app-date" style="font-size: 12px; color: #AAA; margin: 0;">...</p></div>
                        <div style="font-size: 24px; color: var(--primary);"><i class="fa-solid fa-trophy"></i></div>
                    </div>
                    <div style="margin-top: 30px;">
                        <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;"><div id="app-progress" style="width: 0%; height: 100%; background: var(--green);"></div></div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: #AAA;">
                            <span id="app-remaining" style="font-weight: 500;">Calculando...</span>
                            <span id="app-percent" style="color: var(--green); font-weight: 700;">0% Concluído</span>
                        </div>
                    </div>
                </div>
                <!-- Frase -->
                <div id="quote-section" class="quote-card"><i class="fa-solid fa-quote-right quote-icon"></i><p id="daily-quote" style="font-size: 14px; color: var(--dark); font-weight: 500; font-style: italic; line-height: 1.6;">"Carregando inspiração..."</p><p style="font-size: 10px; color: var(--gray); margin-top: 10px; text-transform: uppercase; font-weight: 700;">Motivação do Dia</p></div>
            </div>
            <!-- TREINOS -->
            <div id="tab-workouts" class="tab-content hidden" style="padding: 24px;">
                <h2 style="margin-bottom: 20px; margin-top: 20px;">Sua Planilha</h2>
                <div class="timeline"><div class="line"></div><div id="workouts-container"></div></div>
            </div>
            <!-- PERFIL -->
            <div id="tab-profile" class="tab-content hidden" style="padding: 40px; text-align: center;">
                <div class="avatar-container"><i class="fa-solid fa-user" id="user-icon-profile"></i><img id="user-avatar-profile" src=""></div>
                <h2 id="profile-name" style="margin: 0;">Nome</h2>
                <p style="color: var(--primary); font-size: 12px; font-weight: 700; background: rgba(94,92,230,0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; margin-top: 10px;">ALUNO ATIVO</p>
                <button onclick="app.showProfileSettings()" class="btn" style="background: var(--white); border: 1px solid #EEE; color: var(--gray); margin-top: 30px;">Editar Perfil</button>
            </div>
        </div>
        <!-- Menu -->
        <div class="nav-bar">
            <button class="nav-item active" onclick="app.nav('home')" data-tab="home"><i class="fa-solid fa-house"></i><span>Início</span></button>
            <button class="nav-item" onclick="app.nav('workouts')" data-tab="workouts"><i class="fa-solid fa-calendar-check"></i><span>Treino</span></button>
            <button class="nav-item" onclick="app.nav('profile')" data-tab="profile"><i class="fa-solid fa-user"></i><span>Perfil</span></button>
        </div>
    </div>

    <!-- 5. ADMIN -->
    <div id="view-admin" class="screen" style="background: var(--bg);">
        <div class="header" style="background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px 24px;">
            <h3>Painel Treinador</h3>
            <div>
                <button onclick="app.adminTab('users')" class="btn-icon active" id="adm-tab-users" style="margin-right: 10px; width:35px; height:35px; font-size:12px;"><i class="fa-solid fa-users"></i></button>
                <button onclick="app.adminTab('quotes')" class="btn-icon" id="adm-tab-quotes" style="margin-right: 10px; width:35px; height:35px; font-size:12px;"><i class="fa-solid fa-quote-right"></i></button>
                <button onclick="app.goToLogin()" style="border: none; background: none; color: var(--red); font-weight: bold; cursor: pointer; font-size: 12px;">Sair</button>
            </div>
        </div>
        <div id="admin-content-users" style="padding: 24px; overflow-y: auto; flex: 1;"><div id="admin-list"></div></div>
        <div id="admin-content-quotes" class="hidden" style="padding: 24px; overflow-y: auto; flex: 1;">
            <div class="card"><div class="input-group" style="margin-bottom: 10px;"><label class="label">Nova Frase</label><textarea id="new-quote-text" class="input" style="resize: none; height: 80px;"></textarea></div><button onclick="app.addQuote()" class="btn btn-primary" style="padding: 12px; font-size: 14px;">ADICIONAR</button></div>
            <div id="admin-quotes-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="admin-editor" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; transform: translateY(100%); transition: transform 0.3s ease; display: flex; flex-direction: column;">
        <div style="padding: 20px; background: var(--white); display: flex; justify-content: space-between; align-items: center;"><button onclick="app.closeEditor()" style="border: none; background: none; font-size: 20px;"><i class="fa-solid fa-chevron-down"></i></button><h3 style="margin: 0; font-size: 16px;">Editar Aluno</h3><button onclick="app.saveAdminData()" style="border: none; background: var(--primary); color: white; padding: 8px 20px; border-radius: 10px; font-weight: 700;">Salvar</button></div>
        <div style="flex: 1; overflow-y: auto; padding: 24px;">
            <div class="card" style="display: flex; justify-content: space-between; align-items: center;"><div><strong id="adm-name-display" style="font-size: 18px;">Nome</strong><p style="font-size: 12px; color: var(--gray); margin: 0;">Liberar Acesso</p></div><label class="switch"><input type="checkbox" id="adm-active"><span class="slider"></span></label></div>
            <div class="card"><div class="input-group"><label class="label">Nome da Prova</label><input type="text" id="adm-race" class="input"></div><div class="input-group" style="margin: 0;"><label class="label">Data</label><input type="date" id="adm-date" class="input"></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><h4 style="margin: 0; font-size: 12px; color: var(--gray);">PLANILHA (20 DIAS)</h4><button onclick="app.fillDefaults()" style="border: 1px solid #DDD; background: white; padding: 5px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; color: var(--primary);">Preencher Padrão</button></div>
            <div id="adm-workouts-list" style="display: flex; flex-direction: column; gap: 10px; padding-bottom: 50px;"></div>
        </div>
    </div>
    <div id="modal-profile-settings" class="modal-overlay" style="display: none;">
        <div class="modal-card"><h3 style="margin-top: 0; text-align: center; margin-bottom: 20px;">Editar Perfil</h3><div class="avatar-container" onclick="document.getElementById('edit-profile-file').click()"><i class="fa-solid fa-user" id="edit-profile-icon"></i><img id="edit-profile-img" src=""><div class="avatar-overlay">ALTERAR</div><input type="file" id="edit-profile-file" accept="image/*" style="display: none;" onchange="app.handleAvatarPreview(this)"></div><div class="input-group"><label class="label">Seu Nome</label><input type="text" id="edit-profile-name" class="input"></div><button onclick="app.saveProfileSettings()" class="btn btn-primary" style="margin-bottom: 10px;">Salvar Alterações</button><button onclick="app.closeProfileSettings()" class="btn-text" style="width: 100%;">Cancelar</button></div>
    </div>
    <div id="modal-admin-auth" class="modal-overlay" style="display: none;">
        <div class="modal-card"><h3 style="margin-top: 0; text-align: center; margin-bottom: 20px;">Acesso Treinador</h3><div class="input-group"><label class="label">Senha Mestra</label><input type="password" id="admin-pass-input" class="input" placeholder="******"></div><div style="display: flex; gap: 10px;"><button onclick="app.closeAdminAuth()" class="btn" style="background: #EEE; color: #555;">Cancelar</button><button onclick="app.checkAdminAuth()" class="btn btn-primary">Entrar</button></div></div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAZc5IXA3PRIadz87sysrC_7lLZZG-7Izw", authDomain: "app-corrida-d3568.firebaseapp.com", projectId: "app-corrida-d3568", storageBucket: "app-corrida-d3568.firebasestorage.app", messagingSenderId: "690843260846", appId: "1:690843260846:web:e32be21759c9e813bada3f", measurementId: "G-26RNCCZYED" };
        
        let auth, db; let useMock = false;
        try { const appInit = initializeApp(firebaseConfig); auth = getAuth(appInit); db = getFirestore(appInit); } catch (e) { useMock = true; }
        
        const usersColl = 'expliq_users_v3'; const quotesColl = 'expliq_quotes_v3';
        const getRef = (c) => useMock ? null : collection(db, c);
        const getDocRef = (c, k) => useMock ? null : doc(db, c, k.replace(/[^a-zA-Z0-9]/g, '_'));

        window.app = {
            currentUser: null, editEmail: null, unsubscribeUser: null, unsubscribeAdmin: null, unsubscribeQuotes: null, mockDB: [], mockQuotes: ["Persistência é o caminho do êxito.", "Não pare quando estiver cansado, pare quando tiver terminado."],

            init: async () => {
                if (!useMock) { try { await signInAnonymously(auth); } catch (e) {} }
                app.switchScreen('view-login');
            },
            switchScreen: (id) => { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); },
            
            // Profile
            showProfileSettings: () => {
                const u = app.currentUser; document.getElementById('edit-profile-name').value = u.name;
                const imgEl = document.getElementById('edit-profile-img'); const iconEl = document.getElementById('edit-profile-icon');
                if(u.avatar){ imgEl.src=u.avatar; imgEl.classList.add('has-image'); iconEl.style.display='none'; }
                else { imgEl.src=''; imgEl.classList.remove('has-image'); iconEl.style.display='block'; }
                document.getElementById('modal-profile-settings').style.display = 'flex';
                setTimeout(() => document.getElementById('modal-profile-settings').classList.add('active'), 10);
            },
            closeProfileSettings: () => { document.getElementById('modal-profile-settings').classList.remove('active'); setTimeout(() => document.getElementById('modal-profile-settings').style.display = 'none', 300); },
            handleAvatarPreview: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            let w = img.width, h = img.height; const max = 200;
                            if(w>h){ if(w>max){ h*=max/w; w=max; } } else { if(h>max){ w*=max/h; h=max; } }
                            canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                            const data = canvas.toDataURL('image/jpeg', 0.7);
                            const imgEl = document.getElementById('edit-profile-img'); imgEl.src=data; imgEl.classList.add('has-image'); document.getElementById('edit-profile-icon').style.display='none';
                        };
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            saveProfileSettings: async () => {
                const newName = document.getElementById('edit-profile-name').value;
                const imgEl = document.getElementById('edit-profile-img');
                const newAvatar = imgEl.classList.contains('has-image') ? imgEl.src : null;
                app.currentUser.name = newName; app.currentUser.avatar = newAvatar;
                app.loadAppUI(); app.closeProfileSettings();
                if (!useMock) await updateDoc(getDocRef(usersColl, app.currentUser.email), { name: newName, avatar: newAvatar });
            },

            // Admin Auth
            showAdminAuth: () => { document.getElementById('modal-admin-auth').style.display='flex'; setTimeout(()=>document.getElementById('modal-admin-auth').classList.add('active'),10); document.getElementById('admin-pass-input').value=''; },
            closeAdminAuth: () => { document.getElementById('modal-admin-auth').classList.remove('active'); setTimeout(()=>document.getElementById('modal-admin-auth').style.display='none',300); },
            checkAdminAuth: () => { if(document.getElementById('admin-pass-input').value === 'admin123') { app.closeAdminAuth(); app.goToAdmin(); } else alert("Senha incorreta"); },

            // Nav
            goToLogin: () => { document.getElementById('login-error').style.display='none'; app.switchScreen('view-login'); },
            goToRegister: () => app.switchScreen('view-register'),
            goToAdmin: () => {
                app.switchScreen('view-admin'); app.adminTab('users');
                if (!useMock) {
                    if(app.unsubscribeAdmin) app.unsubscribeAdmin();
                    app.unsubscribeAdmin = onSnapshot(getRef(usersColl), (s) => { const l=[]; s.forEach(d=>l.push(d.data())); app.renderAdminList(l); });
                    if(app.unsubscribeQuotes) app.unsubscribeQuotes();
                    app.unsubscribeQuotes = onSnapshot(getRef(quotesColl), (s) => { const l=[]; s.forEach(d=>l.push({id:d.id,...d.data()})); app.renderAdminQuotes(l); });
                } else { app.renderAdminList(app.mockDB); app.renderAdminQuotes(app.mockQuotes.map((q,i)=>({id:i,text:q}))); }
            },
            adminTab: (t) => {
                document.getElementById('admin-content-users').classList.add('hidden'); document.getElementById('admin-content-quotes').classList.add('hidden');
                document.getElementById('adm-tab-users').classList.remove('active'); document.getElementById('adm-tab-quotes').classList.remove('active');
                document.getElementById('admin-content-'+t).classList.remove('hidden'); document.getElementById('adm-tab-'+t).classList.add('active');
            },
            logout: () => { app.currentUser=null; if(app.unsubscribeUser) app.unsubscribeUser(); document.querySelectorAll('input').forEach(i=>i.value=''); app.switchScreen('view-login'); },
            nav: (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>{e.classList.remove('active'); if(e.dataset.tab===t)e.classList.add('active');}); },

            // Auth Logic
            handleRegister: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-reg'); btn.classList.add('loading');
                const name = document.getElementById('reg-name').value; const email = document.getElementById('reg-email').value.toLowerCase(); const pass = document.getElementById('reg-pass').value;
                const newUser = { name, email, pass, active: false, race: {name:'', date:''}, workouts: Array(20).fill({title:'',desc:'',done:false}), avatar: null };
                if(!useMock) { try{ await setDoc(getDocRef(usersColl, email), newUser); } catch(e){ useMock=true; app.mockDB.push(newUser); } } else app.mockDB.push(newUser);
                btn.classList.remove('loading'); app.switchScreen('view-pending');
            },
            handleLogin: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-login'); const err = document.getElementById('login-error'); btn.classList.add('loading'); err.style.display='none';
                const email = document.getElementById('log-email').value.toLowerCase(); const pass = document.getElementById('log-pass').value;
                let user = null;
                if(!useMock) { try{ const s = await getDoc(getDocRef(usersColl, email)); if(s.exists()) user=s.data(); } catch(e){} }
                if(!user) user = app.mockDB.find(u=>u.email===email);
                btn.classList.remove('loading');
                if(user && user.pass === pass) {
                    app.currentUser = user;
                    if(!useMock) { if(app.unsubscribeUser) app.unsubscribeUser(); app.unsubscribeUser = onSnapshot(getDocRef(usersColl, email), (d)=>{ if(d.exists()){ app.currentUser=d.data(); if(document.getElementById('view-app').classList.contains('active')) app.loadAppUI(); if(app.currentUser.active && document.getElementById('view-pending').classList.contains('active')) { app.loadAppUI(); app.switchScreen('view-app'); } } }); }
                    app.loadRandomQuote();
                    user.active ? (app.loadAppUI(), app.switchScreen('view-app')) : app.switchScreen('view-pending');
                } else { err.innerText = !user ? 'Usuário não encontrado. Crie uma conta.' : 'Senha incorreta.'; err.style.display='block'; }
            },

            loadAppUI: () => {
                const u = app.currentUser;
                document.getElementById('user-name').innerText = u.name; document.getElementById('profile-name').innerText = u.name;
                const updateAv = (id) => {
                    const img = document.getElementById(id); const icon = img.parentElement.querySelector('i');
                    if(u.avatar) { img.src=u.avatar; img.style.display='block'; if(icon) icon.style.display='none'; }
                    else { img.style.display='none'; if(!icon) { const i = document.createElement('i'); i.className='fa-solid fa-user'; i.style.fontSize='20px'; i.style.color='#AAA'; img.parentElement.appendChild(i); img.parentElement.style.display='flex'; img.parentElement.style.alignItems='center'; img.parentElement.style.justifyContent='center'; } else icon.style.display='block'; }
                };
                updateAv('user-avatar-home'); updateAv('user-avatar-profile');
                
                document.getElementById('app-race').innerText = u.race.name || 'Aguardando...';
                let d = 'DATA INDEFINIDA'; if(u.race.date) d = u.race.date.split('-').reverse().join('/'); document.getElementById('app-date').innerText = d;
                
                const cont = document.getElementById('workouts-container'); cont.innerHTML = '';
                let done = 0; const total = u.workouts.length || 20;
                u.workouts.forEach((w,i) => {
                    if(w.done) done++;
                    const next = !w.done && (i===0 || u.workouts[i-1].done);
                    if(!w.title) return;
                    let html = '';
                    if(w.done) html = `<div class="workout done"><div class="w-icon"><i class="fa-solid fa-check"></i></div><div class="w-card" style="display:flex; justify-content:space-between;"><span style="text-decoration: line-through; color: #AAA;">${w.title}</span><span style="color:var(--green); font-size:10px; font-weight:700;">FEITO</span></div></div>`;
                    else if(next) html = `<div class="workout active"><div class="w-icon">${i+1}</div><div class="w-card" style="border-left:4px solid var(--primary);"><span style="color:var(--primary); font-size:10px; font-weight:700;">HOJE</span><h4 style="margin:5px 0;">${w.title}</h4><p style="font-size:12px; color:#888; margin-bottom:15px;">${w.desc}</p><button onclick="app.finishWorkout(${i})" class="btn btn-primary" style="padding:10px; font-size:12px;">CONCLUIR</button></div></div>`;
                    else html = `<div class="workout" style="opacity:0.5;"><div class="w-icon">${i+1}</div><div class="w-card"><h4 style="margin:0; font-size:14px;">${w.title}</h4><span style="font-size:10px;">Bloqueado</span></div></div>`;
                    cont.innerHTML += html;
                });
                const pct = Math.round((done/total)*100);
                document.getElementById('app-progress').style.width = pct+'%'; document.getElementById('app-remaining').innerText = `Faltam ${total-done} treinos`; document.getElementById('app-percent').innerText = `${pct}% Concluído`;
            },
            loadRandomQuote: async () => {
                if(!useMock) {
                    onSnapshot(getRef(quotesColl), (s) => { if(!s.empty) { const all=[]; s.forEach(d=>all.push(d.data().text)); if(all.length>0) document.getElementById('daily-quote').innerText = `"${all[Math.floor(Math.random()*all.length)]}"`; } });
                } else document.getElementById('daily-quote').innerText = `"${app.mockQuotes[Math.floor(Math.random()*app.mockQuotes.length)]}"`;
            },
            finishWorkout: async (i) => { app.currentUser.workouts[i].done=true; app.loadAppUI(); if(!useMock) await updateDoc(getDocRef(usersColl, app.currentUser.email), {workouts:app.currentUser.workouts}); },
            
            // Admin Logic
            renderAdminList: (users) => {
                const list = document.getElementById('admin-list'); list.innerHTML = '';
                if(!users || users.length===0) { list.innerHTML = '<p style="text-align:center; color:#AAA;">Vazio.</p>'; return; }
                users.forEach(u => {
                    const st = u.active ? '<span style="color:var(--green); font-weight:700; font-size:12px;">ATIVO</span>' : '<span style="color:var(--orange); font-weight:700; font-size:12px;">PENDENTE</span>';
                    const d = document.createElement('div'); d.className='card'; d.style.cssText='display:flex; justify-content:space-between; align-items:center; cursor:pointer;';
                    d.innerHTML = `<div><h4 style="margin:0;">${u.name}</h4><p style="margin:0; font-size:12px; color:#888;">${u.email}</p></div>${st}`;
                    d.onclick = () => app.openEditor(u.email); list.appendChild(d);
                });
            },
            renderAdminQuotes: (qs) => {
                const l = document.getElementById('admin-quotes-list'); l.innerHTML='';
                if(qs.length===0) { l.innerHTML='<p style="font-size:12px; color:#AAA;">Sem frases.</p>'; return; }
                qs.forEach(q => {
                    l.innerHTML += `<div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;"><p style="margin:0; font-size:12px; font-style:italic;">"${q.text}"</p><button onclick="app.deleteQuote('${q.id}')" style="border:none; background:none; color:var(--red); cursor:pointer;"><i class="fa-solid fa-trash"></i></button></div>`;
                });
            },
            addQuote: async () => { const t = document.getElementById('new-quote-text').value; if(!t)return; if(!useMock) await addDoc(getRef(quotesColl), {text:t, created:Date.now()}); else { app.mockQuotes.push(t); app.renderAdminQuotes(app.mockQuotes.map((q,i)=>({id:i,text:q}))); } document.getElementById('new-quote-text').value=''; },
            deleteQuote: async (id) => { if(!useMock) await deleteDoc(doc(db, quotesColl, id)); else alert("Apenas online."); },
            openEditor: (email) => {
                app.editEmail = email;
                if(!useMock) getDoc(getDocRef(usersColl, email)).then(s=>{ if(s.exists()) app.fillEditor(s.data()); });
                else app.fillEditor(app.mockDB.find(u=>u.email===email));
                document.getElementById('admin-editor').style.transform = 'translateY(0)';
            },
            fillEditor: (u) => {
                document.getElementById('adm-name-display').innerText=u.name; document.getElementById('adm-active').checked=u.active;
                document.getElementById('adm-race').value=u.race.name||''; document.getElementById('adm-date').value=u.race.date||'';
                const l = document.getElementById('adm-workouts-list'); l.innerHTML='';
                const wks = u.workouts || [];
                for(let i=0; i<20; i++){
                    const w = wks[i]||{title:'',desc:'',done:false};
                    l.innerHTML += `<div style="background:#FFF; border:1px solid #EEE; padding:10px; border-radius:10px; display:flex; gap:10px;"><span style="font-weight:700; color:#AAA; font-size:12px; margin-top:5px;">${i+1}</span><div style="flex:1;"><input type="text" class="edt-t" value="${w.title}" placeholder="Título" style="width:100%; border:none; font-weight:700; font-size:12px; margin-bottom:5px; outline:none;"><input type="text" class="edt-d" value="${w.desc}" placeholder="Detalhes..." style="width:100%; border:none; font-size:11px; color:#666; outline:none;"></div></div>`;
                }
            },
            closeEditor: () => document.getElementById('admin-editor').style.transform = 'translateY(100%)',
            saveAdminData: async () => {
                const active = document.getElementById('adm-active').checked; const rN = document.getElementById('adm-race').value; const rD = document.getElementById('adm-date').value;
                const ts = document.querySelectorAll('.edt-t'); const ds = document.querySelectorAll('.edt-d'); const w=[];
                ts.forEach((t,i) => w.push({title:t.value, desc:ds[i].value, done:false}));
                const data = { active, race:{name:rN, date:rD}, workouts:w };
                if(!useMock) await updateDoc(getDocRef(usersColl, app.editEmail), data); else { const i = app.mockDB.findIndex(u=>u.email===app.editEmail); if(i>-1) app.mockDB[i]={...app.mockDB[i], ...data}; app.renderAdminList(app.mockDB); }
                alert('Salvo!'); app.closeEditor();
            },
            fillDefaults: () => {
                const ts = document.querySelectorAll('.edt-t'); const ds = document.querySelectorAll('.edt-d');
                const tpls = [{t:'Caminhada', d:'30min'}, {t:'Trote', d:'3km'}, {t:'Tiros', d:'10x400m'}, {t:'Longo', d:'5km'}];
                ts.forEach((t,i) => { t.value = tpls[i%tpls.length].t; ds[i].value = tpls[i%tpls.length].d; });
            }
        };
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
