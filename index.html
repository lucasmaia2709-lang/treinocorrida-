<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>.Nuts</title>
    
    <!-- PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content=".Nuts">
    
    <!-- ÍCONE DO APP ATUALIZADO -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lucasmaia2709-lang/treinocorrida-/refs/heads/main/logo.jpg">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/lucasmaia2709-lang/treinocorrida-/refs/heads/main/logo.jpg">

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Importando Bodoni Moda e Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,500;0,6..96,700;1,6..96,400&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* PALETA PERSONALIZADA (SEM PRETO) */
            --bg: #dbffae;         /* Fundo Verde Principal */
            
            --primary: #ff8a41;    /* Laranja (Ação/Botões/Destaques) */
            --secondary: #aaccef;  /* Azul Claro (Detalhes) */
            
            --surface: #FFFFFF;    /* Branco (Cards/Menu) */
            
            /* SUBSTITUIÇÃO DO PRETO/CINZA */
            --text-main: #2b4c7e;  /* Azul Profundo (Legível e dentro da paleta) */
            --text-sec: #e67e22;   /* Laranja Escuro (Para textos secundários) */
            
            --radius: 20px;
            
            /* FONTES */
            --font-main: 'Bodoni Moda', serif; 
            --font-logo: 'Playfair Display', serif;
            
            --success: #2ecc71;    /* Verde mais vibrante */
            --red: #e74c3c;
            --border: #edf2f7;
            --shadow: 0 8px 25px rgba(43, 76, 126, 0.1); /* Sombra azulada */
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: var(--font-main); 
            background-color: var(--bg); 
            color: var(--text-main); 
            width: 100vw;
            height: 100vh;
            height: 100dvh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        h1, h2, h3, h4, strong { font-weight: 700; letter-spacing: -0.5px; color: var(--primary); }

        /* Estilo especial para o Logo .Nuts */
        .brand-logo {
            font-family: var(--font-logo);
            font-weight: 700;
            font-size: 26px;
            color: var(--primary); 
            letter-spacing: -1px;
            text-shadow: 1px 1px 0px #fff;
        }

        /* SCREENS */
        .screen { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--bg); 
            display: none; 
            flex-direction: column; 
            z-index: 10; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: 90px;
        }
        
        #view-app.screen {
            display: none;
            padding-top: 0;
        }
        #view-app.screen.active {
            display: flex;
        }

        .screen.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.full-screen { z-index: 200; background: var(--bg); padding-top: env(safe-area-inset-top); padding-bottom: 0; }
        .screen.detail-view { z-index: 150; background: var(--bg); padding-bottom: 90px; }
        
        #view-admin.screen.full-screen.active {
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            background: #f8fff0; /* Fundo muito levemente verde para o admin */
        }

        /* HEADER PRINCIPAL DO APP */
        .app-header {
            padding: 10px 20px;
            padding-top: max(15px, env(safe-area-inset-top)); 
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent; 
            position: sticky;
            top: 0;
            z-index: 50;
        }

        #main-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-height) + 20px);
            -webkit-overflow-scrolling: touch;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group { margin-bottom: 20px; width: 100%; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--primary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .input { width: 100%; padding: 18px; border-radius: var(--radius); border: 2px solid transparent; background-color: #FFF; font-size: 16px; color: var(--text-main); outline: none; font-family: var(--font-main); transition: 0.2s; -webkit-appearance: none; box-shadow: var(--shadow); }
        .input:focus { border-color: var(--secondary); }
        
        /* Botões */
        .btn { width: 100%; padding: 18px; border-radius: var(--radius); border: none; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: var(--font-main); transition: 0.2s; -webkit-user-select: none; letter-spacing: 0.5px; }
        .btn-primary { background-color: var(--primary); color: #FFF; box-shadow: 0 5px 15px rgba(255, 138, 65, 0.4); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-text { background: none; color: var(--text-sec); font-size: 14px; padding: 10px; }
        .btn-danger { background-color: #ffe6e6; color: var(--red); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        
        /* CALENDÁRIO */
        .calendar-wrapper { padding: 0 20px 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-title { font-weight: 700; font-size: 24px; text-transform: capitalize; color: var(--text-main); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; }
        .cal-head-day { font-size: 10px; color: var(--text-sec); text-align: center; font-weight: 700; padding-bottom: 5px; text-transform: uppercase; }
        .cal-cell { aspect-ratio: 1/1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: 500; color: var(--text-main); position: relative; cursor: pointer; border: 1px solid transparent; background: #FFF; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cal-cell.today { border: 2px solid var(--primary); color: var(--primary); font-weight: 800; }
        .cal-cell.other-month { opacity: 0.4; background: rgba(255,255,255,0.5); }
        .cal-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 3px; }
        .cal-cell.has-workout .cal-dot { background: var(--text-sec); }
        .cal-cell.done .cal-dot { background: var(--success); }
        .cal-cell.done { background: #e0f7fa; color: var(--text-main); }
        .cal-note-indicator { position: absolute; top: 3px; right: 3px; width: 5px; height: 5px; background: var(--secondary); border-radius: 50%; }

        /* CARDS */
        .card { background: var(--surface); border-radius: var(--radius); padding: 25px; border: none; box-shadow: var(--shadow); margin-bottom: 20px; }
        
        /* RECIPE CARD */
        .recipe-card { display: flex; flex-direction: column; overflow: hidden; background: #FFF; border-radius: var(--radius); border: none; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s; }
        .recipe-card:active { transform: scale(0.98); }
        .recipe-img { width: 100%; height: 180px; background-size: cover; background-position: center; margin-bottom: 15px; background-color: #F0F0F0; }
        .recipe-meta { font-size: 11px; color: var(--primary); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        
        /* NEWS CARD */
        .news-card { overflow: hidden; padding: 0; display: flex; flex-direction: column; border: none; box-shadow: var(--shadow); border-radius: var(--radius); background: #FFF; margin-bottom: 20px; }
        .news-img { width: 100%; height: 220px; object-fit: cover; background: #EEE; }
        .news-content { padding: 25px; }
        .news-date { font-size: 11px; color: var(--secondary); margin-bottom: 8px; text-transform: uppercase; font-weight: 700; }
        .news-title { font-size: 18px; font-weight: 700; margin: 0 0 10px 0; line-height: 1.2; font-family: var(--font-logo); color: var(--text-main); }

        /* NAV BAR */
        .nav-bar { 
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            right: 20px;
            width: calc(100% - 40px);
            height: 70px;
            background: #FFFFFF; 
            border-radius: 35px;
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            padding: 0 10px;
            z-index: 300; 
            box-shadow: 0 10px 30px rgba(43, 76, 126, 0.1);
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0; background: none; border: none; color: #cbd5e0; cursor: pointer; }
        .nav-item i { font-size: 24px; transition: 0.3s; margin-bottom: 2px; }
        .nav-item span { font-size: 9px; font-weight: 700; letter-spacing: 0.5px; display: none; } 
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.1); }
        .nav-item.active span { display: block; } 

        .hidden { display: none !important; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-50px); background: var(--text-main); color: #FFF; padding: 12px 24px; border-radius: 50px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 5000; pointer-events: none; text-align: center; min-width: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .header-avatar { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; background: #FFF; cursor: pointer; border: 2px solid var(--text-main); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--text-main); box-shadow: var(--shadow); }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-card { width: 90%; max-width: 400px; background: #FFF; border-radius: 30px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; border: 1px solid rgba(0,0,0,0.05); }
        
        /* ADMIN TABS */
        .admin-header { background: #FFF; color: var(--text-main); padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); flex-shrink: 0; border-bottom: 1px solid #EEE; }
        .admin-tabs-wrapper { background: #FFF; border-bottom: 1px solid #ddd; overflow-x: auto; flex-shrink: 0; display: flex; }
        .admin-content-scroll { flex: 1; overflow-y: auto; padding-bottom: 50px; background: #f8fff0; }
        .admin-tab-btn { flex:1; min-width: 80px; padding:15px; border:none; background:none; cursor:pointer; font-size:12px; font-weight:600; color: var(--text-sec); border-bottom: 2px solid transparent; white-space: nowrap; }
        .admin-tab-btn.active { color: var(--primary); border-color: var(--primary); }
        
        .progress-container { 
            width: 100%; 
            background-color: rgba(0,0,0,0.05); 
            border-radius: 12px; 
            height: 14px; 
            margin-top: 20px; 
            overflow: hidden; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary) 0%, #ff6b6b 100%); 
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(255, 138, 65, 0.4); 
        }

        .check-toggle { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; }

        .adm-row-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; color: var(--text-main); }
        .adm-nested { display: none; padding-left: 15px; border-left: 2px solid var(--secondary); margin-left: 5px; margin-top: 5px; }
        .adm-nested.open { display: block; animation: fadeIn 0.2s; }
        .adm-item-box { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .adm-btn-small { padding: 6px 12px; font-size: 11px; border-radius: 8px; border: 1px solid #ddd; background: #FFF; cursor: pointer; font-weight: 600; color: var(--text-main); }
        .adm-action-btn { color: var(--text-sec); border:none; background:none; font-size:12px; padding:5px; cursor:pointer; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- 0. LANDING -->
    <div id="view-landing" class="screen active" style="align-items: center; justify-content: center; padding: 40px; text-align: center;">
        <h1 class="brand-logo" style="font-size: 80px; margin-bottom: 30px; color: var(--primary);">.nuts</h1>
        <p style="color: var(--text-main); letter-spacing: 2px; text-transform: uppercase; font-size: 12px; margin-top: 10px; font-weight: 600;">Your Journey Starts Here</p>
        <div style="width: 100%; margin-top: 80px;">
            <button onclick="app.goToRegister()" class="btn btn-primary" style="margin-bottom: 15px; background: #FFF; color: var(--primary); box-shadow:none; border:2px solid #FFF;">Começar Agora</button>
            <button onclick="app.goToLogin()" class="btn btn-text" style="color: var(--text-main);">Já tenho conta</button>
        </div>
    </div>

    <!-- 1. LOGIN -->
    <div id="view-login" class="screen" style="justify-content: center; padding: 40px;">
        <button onclick="app.goToLanding()" style="position:absolute; top:50px; left:20px; border:none; background:none; font-size:24px; color:var(--text-main);"><i class="fa-solid fa-arrow-left"></i></button>
        <button onclick="app.showAdminAuth()" style="position:absolute; top:50px; right:20px; border:none; background:none; color:var(--text-main); z-index: 50; padding: 10px;"><i class="fa-solid fa-lock"></i></button>
        <h1 class="serif" style="font-size: 32px; margin-bottom: 40px; text-align:center; color: var(--text-main);">Entrar</h1>
        <form onsubmit="app.handleLogin(event)">
            <div class="input-group"><label class="label">Email</label><input type="email" id="log-email" class="input" required></div>
            <div class="input-group"><label class="label">Senha</label><input type="password" id="log-pass" class="input" required></div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Entrar</button>
        </form>
        <p onclick="app.forgotPassword()" style="text-align: center; color: var(--text-sec); font-size: 13px; margin-top: 20px; cursor: pointer; text-decoration: underline;">Esqueci minha senha</p>
    </div>

    <!-- 2. CADASTRO -->
    <div id="view-register" class="screen" style="justify-content: center; padding: 40px;">
        <button onclick="app.goToLanding()" style="position:absolute; top:50px; left:20px; border:none; background:none; font-size:18px; color:var(--text-main);"><i class="fa-solid fa-arrow-left"></i></button>
        <h1 class="serif" style="font-size: 32px; margin-bottom: 40px; text-align:center; color: var(--text-main);">Criar Conta</h1>
        <form onsubmit="app.handleRegister(event)">
            <div class="input-group"><label class="label">Nome</label><input type="text" id="reg-name" class="input" required></div>
            <div class="input-group"><label class="label">Email</label><input type="email" id="reg-email" class="input" required></div>
            <div class="input-group"><label class="label">Senha</label><input type="password" id="reg-pass" class="input" required></div>
            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Cadastrar</button>
        </form>
    </div>

    <!-- 3. PENDENTE -->
    <div id="view-pending" class="screen" style="align-items: center; justify-content: center; padding: 40px; text-align: center;">
        <div style="background:#FFF; padding:40px; border-radius:30px; box-shadow:var(--shadow);">
            <i class="fa-regular fa-clock" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="color:var(--text-main);">Aprovação Pendente</h2>
            <p style="color: var(--text-sec); font-size: 14px;">Seu treinador precisa liberar seu acesso.</p>
            <button onclick="app.logout()" class="btn btn-outline" style="margin-top: 30px;">Sair</button>
        </div>
    </div>

    <!-- 4. APP PRINCIPAL -->
    <div id="view-app" class="screen">
        <!-- Header -->
        <div class="app-header">
            <div class="header-avatar" onclick="app.openProfile()">
                <img id="header-avatar-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <span id="header-avatar-txt">U</span>
            </div>
            <span class="brand-logo" style="font-size: 24px;">.nuts</span>
            <div style="width: 40px;"></div>
        </div>

        <div id="main-scroll">
            <!-- HOME -->
            <div id="tab-home" class="tab-content">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button onclick="app.changeMonth(-1)" style="border:none; background:none; padding:10px; cursor:pointer;"><i class="fa-solid fa-chevron-left" style="color:var(--text-main);"></i></button>
                        <span id="cal-month-title" class="calendar-title">Mês</span>
                        <button onclick="app.changeMonth(1)" style="border:none; background:none; padding:10px; cursor:pointer;"><i class="fa-solid fa-chevron-right" style="color:var(--text-main);"></i></button>
                    </div>
                    <div class="calendar-grid" style="margin-bottom: 5px;">
                        <div class="cal-head-day">D</div><div class="cal-head-day">S</div><div class="cal-head-day">T</div><div class="cal-head-day">Q</div><div class="cal-head-day">Q</div><div class="cal-head-day">S</div><div class="cal-head-day">S</div>
                    </div>
                    <div id="calendar-days" class="calendar-grid"></div>
                </div>
                <div style="padding: 0 20px;">
                    <h3 style="font-size: 18px; margin: 10px 0 15px; color:var(--text-main);">Treino de Hoje</h3>
                    <div id="today-workout-card"></div>
                    <!-- LOCAL ONDE A NOTÍCIA SERÁ INSERIDA -->
                    <div id="home-latest-news" style="margin-top: 30px;"></div>
                </div>
                <!-- NOVO CARD DE MOTIVAÇÃO ESTILIZADO -->
                <div style="padding: 20px;">
                    <div class="card" style="background: linear-gradient(135deg, #dbffae 0%, #aaccef 100%); color: var(--text-main); border: none; padding: 30px; text-align: center; margin-bottom: 20px;">
                        <h3 style="font-size: 14px; margin: 0 0 20px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; color:var(--text-main);">Motivação do Dia</h3>
                        <i class="fa-solid fa-quote-left" style="color: rgba(43, 76, 126, 0.2); font-size: 32px;"></i>
                        <p id="daily-quote" class="serif" style="font-style: italic; font-size: 20px; margin: 20px 0 10px; line-height: 1.4; color:var(--text-main);">Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- TREINOS -->
            <div id="tab-workouts" class="tab-content hidden" style="padding: 0 20px;">
                <h2 style="margin: 20px 0; color:var(--text-main);">Meu Plano</h2>
                <div id="workouts-list"></div>
            </div>

            <!-- SOCIAL -->
            <div id="tab-social" class="tab-content hidden" style="padding: 0 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0;">
                    <h2 style="margin:0; color:var(--text-main);">Comunidade</h2>
                    <button onclick="app.openCreatePost()" class="btn-primary" style="width: auto; padding: 8px 16px; border-radius: 20px; font-size: 12px; border:none; cursor:pointer;"><i class="fa-solid fa-plus"></i> Novo</button>
                </div>
                <div id="social-feed"></div>
            </div>

            <!-- RECEITAS -->
            <div id="tab-recipes" class="tab-content hidden" style="padding: 0 20px;">
                <h2 style="margin: 20px 0; color:var(--text-main);">Receitas</h2>
                <div id="recipes-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
            </div>

            <!-- NOVIDADES -->
            <div id="tab-news" class="tab-content hidden" style="padding: 0 20px;">
                <h2 style="margin: 20px 0; color:var(--text-main);">Novidades</h2>
                <div id="news-feed"></div>
            </div>
        </div>

        <!-- MENU FLUTUANTE ARREDONDADO -->
        <div class="nav-bar">
            <button class="nav-item" onclick="app.nav('social')" data-tab="social"><i class="fa-solid fa-users"></i></button>
            <button class="nav-item" onclick="app.nav('workouts')" data-tab="workouts"><i class="fa-solid fa-person-running"></i></button>
            <button class="nav-item active" onclick="app.nav('home')" data-tab="home"><i class="fa-solid fa-house"></i></button>
            <button class="nav-item" onclick="app.nav('recipes')" data-tab="recipes"><i class="fa-solid fa-utensils"></i></button>
            <button class="nav-item" onclick="app.nav('news')" data-tab="news"><i class="fa-solid fa-bullhorn"></i></button>
        </div>
    </div>

    <!-- TELAS EXTRAS -->

    <!-- PERFIL -->
    <div id="view-profile" class="screen full-screen">
        <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <button onclick="app.closeProfile()" style="border:none; background:none; font-size:24px; cursor:pointer; color:var(--text-main);"><i class="fa-solid fa-times"></i></button>
            <h3 style="margin:0; color:var(--text-main);">Meu Perfil</h3>
            <button onclick="app.logout()" style="border:none; background:none; color:var(--red); font-weight:600; cursor:pointer;">Sair</button>
        </div>
        <div style="padding: 20px; text-align: center;">
            <div style="width: 120px; height: 120px; border-radius: 50%; background: #FFF; margin: 0 auto 20px; overflow: hidden; position: relative; cursor:pointer; border: 4px solid #FFF; box-shadow: var(--shadow);" onclick="document.getElementById('profile-upload').click()">
                <img id="profile-img-big" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <div style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 10px; padding: 4px;">ALTERAR</div>
            </div>
            <input type="file" id="profile-upload" hidden accept="image/*" onchange="app.uploadAvatar(this)">
            <h2 id="profile-name-big" style="margin:0; font-size:28px; color:var(--text-main);">Nome</h2>
            <p id="profile-email-big" style="color: var(--text-sec); font-size: 16px;">email</p>
            
            <button onclick="app.showAddRaceModal()" class="btn btn-primary" style="margin-top: 30px;">+ NOVO OBJETIVO</button>

            <div class="card" style="margin-top: 40px; text-align: left;">
                <h4 style="margin-top:0; color:var(--primary);">Histórico</h4>
                <div id="profile-history"></div>
            </div>
        </div>
    </div>

    <!-- DETALHE DA RECEITA (MODIFICADO: detail-view em vez de full-screen) -->
    <div id="view-recipe-detail" class="screen detail-view">
        <button onclick="app.closeRecipeDetail()" style="position:absolute; top:40px; left:20px; z-index:10; background:white; border:none; width:45px; height:45px; border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1); cursor:pointer; display:flex; justify-content:center; align-items:center;"><i class="fa-solid fa-arrow-left" style="color:var(--text-main);"></i></button>
        <div id="rec-det-img" style="width:100%; height:350px; background:grey; background-size:cover; background-position:center; background-color: #EEE;"></div>
        <div style="background:var(--bg); border-radius:30px 30px 0 0; margin-top:-40px; padding:30px; position:relative; min-height:500px;">
            <h1 id="rec-det-title" class="serif" style="margin:0 0 10px 0; color:var(--text-main);">Titulo</h1>
            <p id="rec-det-meta" style="color:var(--text-sec); margin-bottom:20px;">0 kcal</p>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="background:#FFF; padding:15px; border-radius:15px; flex:1; text-align:center;"><strong id="rec-det-p" style="font-size:18px; color:var(--text-main);">0</strong><br><small style="color:var(--text-sec);">Prot</small></div>
                <div style="background:#FFF; padding:15px; border-radius:15px; flex:1; text-align:center;"><strong id="rec-det-c" style="font-size:18px; color:var(--text-main);">0</strong><br><small style="color:var(--text-sec);">Carb</small></div>
                <div style="background:#FFF; padding:15px; border-radius:15px; flex:1; text-align:center;"><strong id="rec-det-f" style="font-size:18px; color:var(--text-main);">0</strong><br><small style="color:var(--text-sec);">Gord</small></div>
            </div>
            <h3 style="color:var(--primary);">Ingredientes</h3>
            <ul id="rec-det-ing" style="padding-left:20px; color:var(--text-main);"></ul>
            <h3 style="color:var(--primary);">Modo de Preparo</h3>
            <div id="rec-det-steps" style="color:var(--text-main); line-height:1.6;"></div>
        </div>
    </div>

    <!-- MODAIS DE CRIAÇÃO/INTERAÇÃO -->
    <div id="view-create-post" class="screen full-screen">
        <div style="padding: 15px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-top:max(15px, env(safe-area-inset-top));">
            <button onclick="app.closeCreatePost()" class="btn-text" style="padding:10px; font-weight:600;">Cancelar</button>
            <strong style="font-size:18px; color:var(--text-main);">Criar Post</strong>
            <button onclick="app.submitPost()" style="border:none; background:var(--primary); color:white; padding: 8px 20px; border-radius: 20px; font-weight:600; cursor:pointer;">Postar</button>
        </div>
        <textarea id="post-text" style="width:100%; height:200px; border:none; padding:25px; font-family:var(--font-main); font-size:18px; outline:none; resize:none; background:transparent; color:var(--text-main);" placeholder="No que você está pensando?"></textarea>
        <div style="padding: 20px;">
            <div id="post-img-preview" style="width:100%; height:200px; background:#fff; border-radius:20px; display:none; background-size:cover; background-position:center; margin-bottom:20px;"></div>
            <button onclick="document.getElementById('post-file').click()" class="btn btn-outline" style="border-radius:30px; background:#fff;"><i class="fa-solid fa-camera"></i>&nbsp; Adicionar Foto</button>
            <input type="file" id="post-file" hidden accept="image/*" onchange="app.previewPostImg(this)">
        </div>
    </div>

    <div id="modal-video" class="modal-overlay">
        <div style="width: 100%; max-width: 800px; aspect-ratio: 16/9; background: #000; position: relative; border-radius:20px; overflow:hidden;">
            <button onclick="document.getElementById('modal-video').classList.remove('active'); document.getElementById('video-container').innerHTML='';" style="position: absolute; top: 15px; right: 15px; color: white; background: rgba(0,0,0,0.5); width:35px; height:35px; border-radius:50%; border: none; font-size: 18px; cursor:pointer; z-index:10;">✕</button>
            <div id="video-container" style="width:100%; height:100%;"></div>
        </div>
    </div>
    
    <!-- MODAL DETALHE DO DIA (CALENDÁRIO) -->
    <div id="modal-day-detail" class="modal-overlay">
        <div class="modal-card">
            <h3 id="day-det-title" style="color:var(--primary);">Detalhes do Dia</h3>
            <div id="day-det-content"></div>
            <textarea id="day-det-note" class="input" placeholder="Anotações / Feedback do treino..." style="height:120px; resize:none; margin-top:15px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="document.getElementById('modal-day-detail').classList.remove('active')" class="btn btn-outline">Fechar</button>
                <button onclick="app.saveDayNote()" class="btn btn-primary">Salvar Nota</button>
            </div>
        </div>
    </div>

    <!-- MODAIS UI GENÉRICOS (Substituem alert/confirm/prompt) -->
    <div id="modal-prompt" class="modal-overlay">
        <div class="modal-card">
            <h3 id="prompt-title" style="color:var(--text-main);">Entrada</h3>
            <input id="prompt-input" class="input">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button id="prompt-cancel" class="btn btn-outline">Cancelar</button>
                <button id="prompt-confirm" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Novo Modal de Opção (Template vs Vazio) -->
    <div id="modal-option" class="modal-overlay">
        <div class="modal-card">
            <h3 id="opt-title" style="color:var(--text-main);">Escolha</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button id="opt-1" class="btn btn-primary">Opção 1</button>
                <button id="opt-2" class="btn btn-outline">Opção 2</button>
                <button id="opt-cancel" class="btn btn-text">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-card">
            <h3 id="confirm-title" style="color:var(--text-main);">Tem certeza?</h3>
            <p id="confirm-text" style="color:var(--text-sec); font-size:15px; line-height:1.5;"></p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="confirm-cancel" class="btn btn-outline">Não</button>
                <button id="confirm-ok" class="btn btn-danger">Sim</button>
            </div>
        </div>
    </div>
    
    <!-- NOVO MODAL: ADICIONAR TREINO MANUALMENTE (SUBSTITUI PROMPT) -->
    <div id="modal-add-single-workout" class="modal-overlay">
        <div class="modal-card">
            <h3 id="modal-workout-title" style="color:var(--text-main);">Novo Treino</h3>
            <input id="new-w-title" class="input" placeholder="Título (Ex: Trote Leve)" style="margin-bottom:15px;">
            <input id="new-w-desc" class="input" placeholder="Descrição (Ex: 30min zona 2)" style="margin-bottom:15px;">
            <input id="new-w-video" class="input" placeholder="Link do Vídeo (Opcional)" style="margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button onclick="app.saveSingleWorkout()" class="btn btn-primary">Salvar</button>
                <button onclick="document.getElementById('modal-add-single-workout').classList.remove('active')" class="btn btn-outline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: SELECIONAR MODELO (COM LISTA E RADIO) -->
    <div id="modal-select-template" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color:var(--text-main);">Selecionar Modelo</h3>
            <p style="font-size:13px; color:var(--text-sec); margin-bottom:15px;">Escolha um modelo da lista:</p>
            <div id="template-select-list" style="max-height: 250px; overflow-y: auto; border:1px solid #eee; border-radius:15px; padding:10px; margin-bottom:20px;">
                <!-- Lista gerada via JS -->
            </div>
            
            <!-- NOVO: INPUT DE DATA DE INÍCIO -->
            <div style="margin-bottom: 20px;">
                <label class="label">Data de Início do Treino:</label>
                <input type="date" id="template-start-date" class="input">
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="app.confirmTemplateImport()" class="btn btn-primary">Importar</button>
                <button onclick="document.getElementById('modal-select-template').classList.remove('active')" class="btn btn-outline">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAIS DE NEGÓCIO -->
    <div id="modal-admin-auth" class="modal-overlay">
        <div class="modal-card" style="text-align: center;">
            <h3 style="margin-bottom:20px; color:var(--text-main);">Acesso Treinador</h3>
            <input type="password" id="admin-pass-input" class="input" placeholder="Senha" style="text-align: center; margin-bottom: 25px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="document.getElementById('modal-admin-auth').classList.remove('active')" class="btn btn-outline">Cancelar</button>
                <button onclick="app.checkAdminAuth()" class="btn btn-primary">Entrar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-add-race" class="modal-overlay">
        <div class="modal-card">
            <h3 style="color:var(--text-main);">Novo Objetivo</h3>
            <input id="new-race-name" class="input" placeholder="Nome (Ex: Maratona)" style="margin-bottom:10px;">
            <input type="date" id="new-race-date" class="input" style="margin-bottom:10px;">
            <button onclick="app.addStudentRace()" class="btn btn-primary">Criar</button>
            <button onclick="document.getElementById('modal-add-race').classList.remove('active')" class="btn btn-text">Cancelar</button>
        </div>
    </div>

    <!-- PAINEL ADMIN COMPLETO (FIXED HEADER) -->
    <div id="view-admin" class="screen full-screen">
        <div class="admin-header">
            <div style="display: flex; justify-content: space-between;">
                <span style="color:var(--text-main); font-weight:700;">ADMIN</span>
                <button onclick="app.closeAdmin()" style="color: var(--text-main); background: none; border: none; cursor:pointer;">Sair</button>
            </div>
        </div>
        
        <div class="admin-tabs-wrapper">
            <button onclick="app.admTab('users')" id="btn-adm-users" class="admin-tab-btn active">Usuários</button>
            <button onclick="app.admTab('templates')" id="btn-adm-templates" class="admin-tab-btn">Modelos</button>
            <button onclick="app.admTab('news')" id="btn-adm-news" class="admin-tab-btn">Notícias</button>
            <button onclick="app.admTab('recipes')" id="btn-adm-recipes" class="admin-tab-btn">Receitas</button>
            <button onclick="app.admTab('quotes')" id="btn-adm-quotes" class="admin-tab-btn">Frases</button>
        </div>
        
        <div class="admin-content-scroll">
            <!-- Tab Usuários -->
            <div id="adm-content-users" style="padding: 20px;">
                <h3 style="color:var(--text-main);">Usuários</h3>
                <div id="adm-users-list"></div>
            </div>
            
            <!-- Tab Templates (Modelos) -->
            <div id="adm-content-templates" class="hidden" style="padding: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="color:var(--text-main);">Modelos de Treino</h3>
                    <button onclick="app.admAddTemplateInline()" class="btn-primary" style="padding:5px 15px; font-size:12px; border-radius:20px;">+ Novo</button>
                </div>
                <p style="color:var(--text-sec); font-size:12px; margin-bottom:20px;">Gerencie seus modelos de treino.</p>
                <div id="adm-templates-list"></div>
            </div>
            
            <!-- Tab Notícias -->
            <div id="adm-content-news" class="hidden" style="padding: 20px;">
                <h3 style="color:var(--text-main);">Publicar Novidade</h3>
                <div class="card">
                    <input id="news-title" class="input" placeholder="Título" style="margin-bottom:10px;">
                    <textarea id="news-body" class="input" placeholder="Texto..." style="margin-bottom:10px; height:100px; resize:none;"></textarea>
                    <button onclick="document.getElementById('news-file').click()" class="btn" style="border:1px solid #CCC; margin-bottom:10px;">Foto</button>
                    <input type="file" id="news-file" hidden onchange="app.handleNewsImg(this)">
                    <img id="news-preview" style="width:100%; height:100px; object-fit:cover; display:none; margin-bottom:10px;">
                    <button onclick="app.postNews()" class="btn btn-primary">PUBLICAR</button>
                </div>
                <div id="adm-news-history"></div>
            </div>

            <!-- Tab Receitas -->
            <div id="adm-content-recipes" class="hidden" style="padding: 20px;">
                <h3 style="color:var(--text-main);">Adicionar Receita</h3>
                <div class="card">
                    <input id="adm-rec-title" class="input" placeholder="Título" style="margin-bottom:10px;">
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input id="adm-rec-kcal" class="input" placeholder="Kcal" type="number">
                        <input id="adm-rec-time" class="input" placeholder="Min" type="number">
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input id="adm-rec-p" class="input" placeholder="P (g)" type="number">
                        <input id="adm-rec-c" class="input" placeholder="C (g)" type="number">
                        <input id="adm-rec-f" class="input" placeholder="G (g)" type="number">
                    </div>
                    <textarea id="adm-rec-ing" class="input" placeholder="Ingredientes (um por linha)" style="height:80px; margin-bottom:10px; resize:none;"></textarea>
                    <textarea id="adm-rec-steps" class="input" placeholder="Passos (um por linha)" style="height:80px; margin-bottom:10px; resize:none;"></textarea>
                    
                    <button onclick="document.getElementById('adm-rec-file').click()" class="btn" style="border:1px solid #CCC; margin-bottom:10px;">Foto da Receita</button>
                    <input type="file" id="adm-rec-file" hidden onchange="app.handleRecImg(this)">
                    <img id="adm-rec-preview" style="width:100%; height:100px; object-fit:cover; display:none; margin-bottom:10px;">
                    
                    <button onclick="app.postRecipe()" class="btn btn-primary">SALVAR RECEITA</button>
                </div>
                <div id="adm-recipes-list"></div>
            </div>

            <!-- Tab Frases -->
            <div id="adm-content-quotes" class="hidden" style="padding: 20px;">
                <h3 style="color:var(--text-main);">Frases Motivacionais</h3>
                <div class="card">
                    <textarea id="adm-quote-text" class="input" placeholder="Digite a frase..." style="margin-bottom:10px; resize:none;"></textarea>
                    <button onclick="app.postQuote()" class="btn btn-primary">ADICIONAR</button>
                </div>
                <div id="adm-quotes-list"></div>
            </div>
        </div>
    </div>

    <!-- Detalhe Usuário Admin -->
    <div id="adm-user-detail" class="modal-overlay">
        <div class="modal-card">
            <h3 id="adm-u-name" style="color:var(--text-main);">Nome</h3>
            <p id="adm-u-email" style="color:var(--text-sec); margin-bottom: 20px;">email</p>
            <label style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <input type="checkbox" id="adm-u-active"> Acesso Liberado
            </label>
            <hr style="width:100%; border:0; border-top:1px solid #EEE;">
            <h4 style="color:var(--text-main);">Objetivos/Treinos</h4>
            <div id="adm-u-races"></div>
            <button onclick="app.admAddRace()" class="btn" style="margin-top:10px; border:1px dashed #999; color:var(--text-main);">+ Adicionar Objetivo</button>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="app.admSaveUser()" class="btn btn-primary" style="flex:1;">Salvar</button>
                <button onclick="document.getElementById('adm-user-detail').classList.remove('active')" class="btn" style="flex:1; border:1px solid var(--text-sec); color:var(--text-main);">Fechar</button>
            </div>
            <!-- Botão de Excluir -->
            <button onclick="app.admDeleteUser()" class="btn btn-danger" style="margin-top:10px; background:transparent; border:1px solid var(--red); color:var(--red);">Excluir Aluno</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAZc5IXA3PRIadz87sysrC_7lLZZG-7Izw", authDomain: "app-corrida-d3568.firebaseapp.com", projectId: "app-corrida-d3568", storageBucket: "app-corrida-d3568.firebasestorage.app", messagingSenderId: "690843260846", appId: "1:690843260846:web:e32be21759c9e813bada3f", measurementId: "G-26RNCCZYED" };
        const appInit = initializeApp(firebaseConfig);
        const auth = getAuth(appInit);
        const db = getFirestore(appInit);
        const appId = "1:690843260846:web:e32be21759c9e813bada3f";
        
        const C_USERS = 'expliq_users_v9';
        const C_POSTS = 'expliq_posts_v9';
        const C_NEWS = 'expliq_news_v9';
        const C_RECIPES = 'expliq_recipes_v9';
        const C_QUOTES = 'expliq_quotes_v9';
        const C_TEMPLATES = 'expliq_templates_v9';

        let currentUser = null;
        let mockMode = false;
        let currentMonth = new Date();
        let editUserEmail = null; 
        let tempImgBase64 = null;
        let tempRecImg = null;
        let allRecipes = [];
        let selectedDayDate = null; 
        
        // Estado para controlar acordeões abertos
        let expandedUsers = new Set();
        let expandedRaces = new Set();
        let expandedTemplates = new Set(); // Novo estado para templates
        
        // Estado temporário para edição de treino inline
        let currentAdmUser = null;
        let currentAdmRaceIdx = null;
        let isEditingTemplate = false;
        let currentTemplateId = null;
        let editingWorkoutIndex = null; // NOVO: Indice do treino sendo editado

        window.app = {
            init: async () => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        app.loadUser(user.email);
                    } else {
                        app.screen('view-landing');
                    }
                });
                app.renderCalendar();
            },
            
            // FUNÇÃO DE ESCAPE PARA PREVENIR ERROS DE SINTAXE
            escape: (str) => {
                if (!str) return '';
                // Trata aspas simples e duplas
                return str.toString().replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
            },

            // --- UI HELPER FUNCTIONS ---
            screen: (id) => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); const el = document.getElementById(id); if(el) el.classList.add('active'); },
            nav: (tab) => {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                if(tab === 'home') app.renderHome();
                if(tab === 'workouts') app.renderWorkoutsList();
                if(tab === 'social') app.loadFeed();
                if(tab === 'recipes') app.loadRecipes();
                if(tab === 'news') app.loadNews();
            },
            toast: (msg) => { const t = document.getElementById('toast-container'); t.innerHTML = `<div class="toast show">${msg}</div>`; setTimeout(() => t.innerHTML='', 3000); },
            
            showPrompt: (title, callback) => {
                const el = document.getElementById('modal-prompt');
                document.getElementById('prompt-title').innerText = title;
                const inp = document.getElementById('prompt-input');
                inp.value = '';
                el.classList.add('active');
                inp.focus();
                const okBtn = document.getElementById('prompt-confirm');
                const cancelBtn = document.getElementById('prompt-cancel');
                okBtn.replaceWith(okBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                document.getElementById('prompt-confirm').onclick = () => { const val = document.getElementById('prompt-input').value; if(val) callback(val); el.classList.remove('active'); };
                document.getElementById('prompt-cancel').onclick = () => el.classList.remove('active');
            },
            
            showConfirm: (text, callback) => {
                const el = document.getElementById('modal-confirm');
                document.getElementById('confirm-text').innerText = text;
                el.classList.add('active');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                okBtn.replaceWith(okBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                document.getElementById('confirm-ok').onclick = () => { callback(); el.classList.remove('active'); };
                document.getElementById('confirm-cancel').onclick = () => el.classList.remove('active');
            },

            showOption: (title, opt1Txt, opt2Txt, cb1, cb2) => {
                const el = document.getElementById('modal-option');
                document.getElementById('opt-title').innerText = title;
                document.getElementById('opt-1').innerText = opt1Txt;
                document.getElementById('opt-2').innerText = opt2Txt;
                el.classList.add('active');
                document.getElementById('opt-1').onclick = () => { cb1(); el.classList.remove('active'); };
                document.getElementById('opt-2').onclick = () => { cb2(); el.classList.remove('active'); };
                document.getElementById('opt-cancel').onclick = () => el.classList.remove('active');
            },

            goToLogin: () => app.screen('view-login'),
            goToRegister: () => app.screen('view-register'),
            goToLanding: () => app.screen('view-landing'),

            handleRegister: async (e) => {
                e.preventDefault();
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value.toLowerCase();
                const pass = document.getElementById('reg-pass').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    const newUser = { name, email, active: false, avatar: null, races: [], notes: {}, created: Date.now() };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, email), newUser);
                    await signOut(auth);
                    app.toast("Cadastro realizado! Faça login para entrar.");
                    app.screen('view-login');
                } catch(err) { 
                    let msg = 'Erro ao cadastrar.';
                    if(err.code === 'auth/email-already-in-use') msg = 'Email já registado. Por favor, faça login.';
                    else if(err.code === 'auth/weak-password') msg = 'Senha muito fraca.';
                    app.toast(msg); 
                }
            },

            handleLogin: async (e) => {
                e.preventDefault();
                const email = document.getElementById('log-email').value.toLowerCase();
                const pass = document.getElementById('log-pass').value;
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', C_USERS, user.email);
                    const snap = await getDoc(docRef);
                    if (!snap.exists()) {
                        const newUser = { name: "Aluno(a)", email: user.email, active: false, avatar: null, races: [], notes: {}, created: Date.now() };
                        await setDoc(docRef, newUser);
                        app.toast("Conta reativada. Aguarde aprovação.");
                    }
                } catch(err) { app.toast('Email ou senha inválidos.'); }
            },

            forgotPassword: () => {
                app.showPrompt("Digite seu email para recuperar:", (email) => {
                    sendPasswordResetEmail(auth, email)
                    .then(() => app.toast("Email de recuperação enviado!"))
                    .catch(e => app.toast("Erro: " + e.message));
                });
            },

            loadUser: (email) => {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, email), (doc) => {
                    if(doc.exists()) {
                        currentUser = doc.data();
                        if (document.getElementById('view-admin').classList.contains('active')) return;
                        if(!currentUser.active) { app.screen('view-pending'); return; }
                        const av = currentUser.avatar;
                        const himg = document.getElementById('header-avatar-img');
                        const htxt = document.getElementById('header-avatar-txt');
                        if(av) { himg.src=av; himg.style.display='block'; htxt.style.display='none'; }
                        else { himg.style.display='none'; htxt.style.display='block'; htxt.innerText=currentUser.name[0]; }
                        app.screen('view-app');
                        app.nav('home');
                    }
                });
            },

            logout: () => { signOut(auth).then(() => { currentUser = null; app.screen('view-landing'); }); },
            
            openProfile: () => {
                if(!currentUser) return;
                app.screen('view-profile');
                document.getElementById('profile-name-big').innerText = currentUser.name;
                document.getElementById('profile-email-big').innerText = currentUser.email;
                const img = document.getElementById('profile-img-big');
                if(currentUser.avatar) { img.src=currentUser.avatar; img.style.display='block'; }
                const hList = document.getElementById('profile-history');
                hList.innerHTML = '';
                (currentUser.races || []).forEach(r => {
                    const done = r.workouts.filter(w=>w.done).length;
                    const total = r.workouts.length;
                    const pct = total > 0 ? Math.round((done/total)*100) : 0;
                    hList.innerHTML += `<div style="margin-bottom:15px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><strong style="font-size:14px; color:var(--text-main);">${r.name}</strong> <span style="font-size:12px; font-weight:600; color:var(--primary);">${pct}%</span></div><div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:var(--primary);"></div></div></div>`;
                });
            },
            closeProfile: () => app.screen('view-app'),
            uploadAvatar: (input) => {
                app.processImage(input, async (base64) => {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentUser.email), { avatar: base64 });
                    app.openProfile();
                });
            },
            
            showAddRaceModal: () => document.getElementById('modal-add-race').classList.add('active'),
            addStudentRace: async () => {
                const name = document.getElementById('new-race-name').value;
                const date = document.getElementById('new-race-date').value;
                if(!name) return;
                const workouts = []; 
                const races = currentUser.races || [];
                races.push({ name, date, workouts, created: new Date().toISOString() });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentUser.email), { races });
                document.getElementById('modal-add-race').classList.remove('active');
                app.toast('Objetivo criado! Aguarde o professor lançar os treinos.');
                app.openProfile();
            },

            changeMonth: (dir) => { currentMonth.setMonth(currentMonth.getMonth() + dir); app.renderCalendar(); },
            renderCalendar: () => {
                if(!currentUser) return;
                const y = currentMonth.getFullYear();
                const m = currentMonth.getMonth();
                const firstDay = new Date(y, m, 1).getDay();
                const daysInMonth = new Date(y, m+1, 0).getDate();
                document.getElementById('cal-month-title').innerText = currentMonth.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const grid = document.getElementById('calendar-days');
                grid.innerHTML = '';
                
                const activeRace = (currentUser.races && currentUser.races.length) ? currentUser.races[currentUser.races.length-1] : null;
                const workouts = activeRace ? activeRace.workouts : [];
                const notes = currentUser.notes || {};
                let projectionIndex = 0;
                const pendingWorkouts = workouts.filter(w => !w.done);
                const todayStr = new Date().toISOString().split('T')[0];

                for(let i=0; i<firstDay; i++) { grid.innerHTML += `<div class="cal-cell other-month"></div>`; }
                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(y, m, d);
                    const dateStr = dateObj.toISOString().split('T')[0];
                    const isToday = dateStr === todayStr;
                    let cellClass = 'cal-cell';
                    if(isToday) cellClass += ' today';
                    let dotHtml = '';
                    let workoutData = null;
                    
                    const scheduled = workouts.find(w => w.scheduledDate === dateStr);
                    const doneHere = workouts.find(w => w.done && w.completedAt === dateStr);
                    
                    if (scheduled) {
                         cellClass += ' has-workout'; 
                         dotHtml += `<div class="cal-dot"></div>`;
                         workoutData = scheduled;
                         if(scheduled.done) cellClass += ' done';
                    }
                    else if(doneHere) { 
                        cellClass += ' done'; 
                        dotHtml += `<div class="cal-dot"></div>`; 
                        workoutData = doneHere; 
                    } 
                    
                    if(notes[dateStr]) { dotHtml += `<div class="cal-note-indicator"></div>`; }
                    
                    const el = document.createElement('div');
                    el.className = cellClass;
                    el.innerText = d;
                    el.innerHTML += dotHtml;
                    el.onclick = () => app.openDayDetail(dateStr, workoutData);
                    grid.appendChild(el);
                }
            },
            
            openDayDetail: (dateStr, workoutData) => {
                selectedDayDate = dateStr;
                const modal = document.getElementById('modal-day-detail');
                document.getElementById('day-det-title').innerText = `Dia ${dateStr.split('-').reverse().join('/')}`;
                let content = '';
                if(workoutData) {
                    content = `<div style="background:#f5f5f5; padding:15px; border-radius:10px; margin-bottom:15px;">
                        <h4 style="margin:0 0 5px 0; color:var(--text-main);">${workoutData.title}</h4>
                        <p style="margin:0; font-size:13px; color:var(--text-sec);">${workoutData.desc}</p>
                        ${workoutData.done ? '<strong style="color:var(--success); font-size:12px;">Concluído</strong>' : '<span style="color:var(--orange); font-size:12px;">Pendente</span>'}
                    </div>`;
                } else { content = `<p style="color:var(--text-sec); text-align:center; margin-bottom:15px;">Sem treino registrado para este dia.</p>`; }
                document.getElementById('day-det-content').innerHTML = content;
                const notes = currentUser.notes || {};
                document.getElementById('day-det-note').value = notes[dateStr] || '';
                modal.classList.add('active');
            },

            saveDayNote: async () => {
                const note = document.getElementById('day-det-note').value;
                const notes = currentUser.notes || {};
                if(note.trim() === '') delete notes[selectedDayDate];
                else notes[selectedDayDate] = note;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentUser.email), { notes });
                app.toast("Nota salva!");
                document.getElementById('modal-day-detail').classList.remove('active');
                app.renderCalendar();
            },

            renderHome: () => { 
                app.renderCalendar(); 
                app.renderTodayCard(); 
                app.loadQuote(); 
                app.loadHomeNews(); 
            },
            
            loadHomeNews: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_POSTS), (snap) => {
                     // Placeholder
                });

                 onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_NEWS), (snap) => {
                    const news = []; 
                    snap.forEach(d => news.push(d.data())); 
                    news.sort((a,b) => b.created - a.created);
                    
                    const container = document.getElementById('home-latest-news');
                    if(news.length > 0) {
                        const n = news[0];
                        container.innerHTML = `
                            <h3 style="font-size: 16px; margin: 0 0 15px; color:var(--text-main);">Última Novidade</h3>
                            <div class="card news-card" style="margin-bottom:0;">
                                ${n.img ? `<img src="${n.img}" class="news-img" style="height:150px;">` : ''}
                                <div class="news-content" style="padding:15px;">
                                    <div class="news-date" style="font-size:10px;">${new Date(n.created).toLocaleDateString()}</div>
                                    <h3 class="news-title" style="font-size:16px;">${n.title}</h3>
                                    <div class="news-body" style="font-size:13px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color:var(--text-main);">${n.body}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = '';
                    }
                });
            },

            renderTodayCard: (specificWorkout = null) => {
                const activeRace = (currentUser.races && currentUser.races.length) ? currentUser.races[currentUser.races.length-1] : null;
                if(!activeRace || activeRace.workouts.length === 0) { 
                    document.getElementById('today-workout-card').innerHTML = `
                        <div class="card" style="text-align:center; padding:40px 20px;">
                            <i class="fa-regular fa-clock" style="font-size:40px; color:var(--orange); margin-bottom:20px; opacity:0.8;"></i>
                            <p style="font-size:16px; color:var(--text-sec); font-weight:500;">Aguardando seu professor lançar os treinos...</p>
                        </div>`; 
                    return; 
                }
                
                const todayStr = new Date().toISOString().split('T')[0];
                let target = specificWorkout;
                
                if (!target) {
                    target = activeRace.workouts.find(w => w.scheduledDate === todayStr);
                }
                
                if (!target) {
                    target = activeRace.workouts.find(w => w.done && w.completedAt === todayStr);
                }

                if (!target) {
                    target = activeRace.workouts.find(w => !w.done && (!w.scheduledDate || w.scheduledDate >= todayStr));
                }
                
                const container = document.getElementById('today-workout-card');
                
                const totalW = activeRace.workouts.length;
                const doneW = activeRace.workouts.filter(w => w.done).length;
                const pct = totalW > 0 ? (doneW / totalW) * 100 : 0;
                const raceDate = activeRace.date ? new Date(activeRace.date).toLocaleDateString() : 'Sem data';
                let cardHtml = '';
                
                const safeTitle = target ? app.escape(target.title) : '';
                const safeVideo = target && target.video ? app.escape(target.video) : '';
                
                if(target) {
                    const doneBtn = target.done ? `<button class="btn" style="background:rgba(255,255,255,0.2); color:#FFF; flex:1; cursor:default;" disabled><i class="fa-solid fa-check"></i> Feito</button>` : `<button onclick="app.finishWorkout('${safeTitle}')" class="btn" style="background:#FFF; color:var(--text-main); flex:1;">Concluir</button>`;
                    
                    let dateDisplay = "";
                    if(target.scheduledDate) {
                        const dParts = target.scheduledDate.split('-');
                        dateDisplay = `<span style="font-size:12px; color:rgba(255,255,255,0.7); margin-left:8px; font-weight:400;">${dParts[2]}/${dParts[1]}</span>`;
                    }

                    cardHtml = `<div class="card" style="background: linear-gradient(135deg, var(--bg) 0%, var(--secondary) 100%); color: var(--text-main); border: none; padding:30px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:25px;">
                            <div>
                                <h2 style="margin:0; font-size:24px; line-height:1.2; color:var(--text-main);">${target.title} ${dateDisplay}</h2>
                                <p style="opacity:0.9; font-size:15px; margin-top:8px; font-weight:400; color:var(--text-main);">${target.desc}</p>
                            </div>
                            <div style="background:rgba(255,255,255,0.4); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                <i class="fa-solid fa-person-running" style="font-size:24px; color:var(--text-main);"></i>
                            </div>
                        </div>
                        <div style="display:flex; gap:15px;">
                            ${doneBtn}
                            ${safeVideo ? `<button onclick="app.playVideo('${safeVideo}')" class="btn" style="background:rgba(255,255,255,0.4); color:var(--text-main); padding:0 20px; width:auto; display:flex; gap:8px;"><i class="fa-solid fa-play"></i> Vídeo</button>` : ''}
                        </div>
                    </div>`;
                } else {
                    cardHtml = `<div class="card" style="text-align:center; color:var(--success); padding:40px;"><i class="fa-solid fa-circle-check" style="font-size:48px; margin-bottom:15px;"></i><br><strong style="font-size:18px;">Todos os treinos concluídos!</strong></div>`;
                }
                container.innerHTML = cardHtml + `
                    <div style="margin-top:20px; font-size:12px; display:flex; justify-content:space-between; color:var(--text-sec); font-weight:600; text-transform:uppercase; letter-spacing:0.5px;"><span>${doneW}/${totalW} Treinos</span> <span>Meta: ${raceDate}</span></div>
                    <div class="progress-container"><div class="progress-bar" style="width:${pct}%"></div></div>
                `;
            },
            finishWorkout: async (wTitle) => {
                const races = [...currentUser.races];
                const rIdx = races.length - 1;
                const wIdx = races[rIdx].workouts.findIndex(w => w.title === wTitle && !w.done);
                if(wIdx > -1) {
                    races[rIdx].workouts[wIdx].done = true;
                    races[rIdx].workouts[wIdx].completedAt = new Date().toISOString().split('T')[0];
                    currentUser.races = races;
                    app.renderHome();
                    app.toast("Treino Concluído!");
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentUser.email), { races });
                }
            },
            loadQuote: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_QUOTES), (s)=>{
                    const quotes = [];
                    s.forEach(d=>quotes.push(d.data().text));
                    if(quotes.length>0) {
                        document.getElementById('daily-quote').innerText = quotes[Math.floor(Math.random()*quotes.length)];
                    } else {
                        document.getElementById('daily-quote').innerText = "O único treino ruim é aquele que não aconteceu.";
                    }
                });
            },
            playVideo: (url) => {
                let embed = url;
                if (url.includes('github.com') && url.includes('/blob/')) {
                    embed = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                    document.getElementById('video-container').innerHTML = `<video src="${embed}" controls autoplay style="width:100%; height:100%;"></video>`;
                }
                else if(url.includes('youtu')) { 
                    const id = url.split('/').pop().split('?')[0]; 
                    embed = `https://www.youtube.com/embed/${id}?autoplay=1`; 
                    document.getElementById('video-container').innerHTML = `<iframe src="${embed}" style="width:100%; height:100%; border:0;" allow="autoplay; fullscreen"></iframe>`; 
                } 
                else { 
                    document.getElementById('video-container').innerHTML = `<video src="${url}" controls autoplay style="width:100%; height:100%;"></video>`; 
                }
                document.getElementById('modal-video').classList.add('active');
            },
            renderWorkoutsList: () => {
                const activeRace = (currentUser.races && currentUser.races.length) ? currentUser.races[currentUser.races.length-1] : null;
                const list = document.getElementById('workouts-list');
                
                if(!activeRace) { list.innerHTML = ''; return; }
                const pendingCount = activeRace.workouts.filter(w => !w.done).length;
                
                list.innerHTML = `
                <div class="card" style="background:var(--primary); color:#FFF; margin-bottom:25px; padding:25px; display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h2 style="margin:0; font-size:36px; color:#FFF;">${pendingCount}</h2>
                        <p style="margin:0; opacity:0.9; font-size:14px; color:#FFF;">Treinos Restantes</p>
                    </div>
                    <i class="fa-solid fa-list-check" style="font-size:40px; opacity:0.5; color:#FFF;"></i>
                </div>
                `;

                activeRace.workouts.forEach((w, i) => {
                    const color = w.done ? 'var(--success)' : '#E0E0E0';
                    const icon = w.done ? 'fa-circle-check' : 'fa-circle';
                    const safeVideo = w.video ? app.escape(w.video) : '';
                    
                    let dateBadge = '';
                    if(w.scheduledDate) {
                         const dParts = w.scheduledDate.split('-');
                         dateBadge = `<span style="font-size:10px; color:#FFF; background:var(--primary); padding:2px 6px; border-radius:6px; margin-left:8px; font-weight:600;">${dParts[2]}/${dParts[1]}</span>`;
                    }

                    list.innerHTML += `<div class="card" style="display:flex; align-items:center; gap: 15px; opacity: ${w.done?0.6:1}; padding:20px;">
                        <div style="color:${color}; font-size:24px;"><i class="fa-solid ${icon}"></i></div>
                        <div style="flex:1;">
                            <h4 style="margin:0; font-size:16px;">${w.title} ${dateBadge}</h4>
                            <p style="margin:0; font-size:13px; color:var(--text-sec); margin-top:4px;">${w.desc}</p>
                        </div>
                        ${safeVideo ? `<button onclick="app.playVideo('${safeVideo}')" style="border:1px solid var(--secondary); background:transparent; color:var(--text-main); padding: 6px 12px; border-radius: 20px; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:12px; font-weight:600;"><i class="fa-solid fa-play" style="color:var(--primary);"></i> Vídeo</button>` : ''}
                    </div>`;
                });
            },
            loadFeed: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_POSTS), (snap) => {
                    const feed = document.getElementById('social-feed');
                    feed.innerHTML = '';
                    const posts = [];
                    snap.forEach(d => posts.push({id:d.id, ...d.data()}));
                    posts.sort((a,b) => b.created - a.created);
                    posts.forEach(p => {
                        const imgUrl = p.img || p.image; 
                        let deleteBtn = '';
                        if (currentUser && p.email === currentUser.email) {
                            deleteBtn = `<button onclick="app.deletePost('${p.id}')" style="border:none; background:none; color:var(--red); font-size:14px; margin-left:auto;"><i class="fa-solid fa-trash"></i></button>`;
                        }
                        feed.innerHTML += `
                        <div class="card" style="padding:0; overflow:hidden;">
                            <div style="padding:20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #f5f5f5;">
                                <div style="width:40px; height:40px; border-radius:50%; background:#EEE; overflow:hidden;">${p.avatar ? `<img src="${p.avatar}" style="width:100%;height:100%;">` : ''}</div>
                                <div>
                                    <strong style="font-size:15px; display:block; color:var(--text-main);">${p.userName}</strong>
                                    <span style="font-size:11px; color:var(--text-sec);">${new Date(p.created).toLocaleDateString()}</span>
                                </div>
                                ${deleteBtn}
                            </div>
                            ${imgUrl ? `<img src="${imgUrl}" style="width:100%; max-height:400px; object-fit:cover;">` : ''}
                            <div style="padding:20px;"><p style="margin:0; font-size:15px; line-height:1.5; color:var(--text-main);">${p.text}</p></div>
                        </div>`;
                    });
                });
            },
            deletePost: async (postId) => {
                app.showConfirm("Excluir sua publicação?", async () => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_POSTS, postId));
                    app.toast("Publicação removida.");
                });
            },
            openCreatePost: () => app.screen('view-create-post'),
            closeCreatePost: () => app.screen('view-app'),
            previewPostImg: (input) => { app.processImage(input, (b64) => { tempImgBase64 = b64; const prev = document.getElementById('post-img-preview'); prev.style.backgroundImage = `url(${b64})`; prev.style.display = 'block'; }); },
            submitPost: async () => {
                const text = document.getElementById('post-text').value;
                if(!text && !tempImgBase64) return;
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', C_POSTS)), { 
                    userName: currentUser.name, 
                    email: currentUser.email, 
                    avatar: currentUser.avatar, 
                    text: text, 
                    img: tempImgBase64, 
                    created: Date.now() 
                });
                document.getElementById('post-text').value = ''; tempImgBase64 = null; document.getElementById('post-img-preview').style.display = 'none'; app.closeCreatePost();
            },
            loadRecipes: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_RECIPES), (snap) => {
                    const l = document.getElementById('recipes-list');
                    l.innerHTML = '';
                    allRecipes = [];
                    snap.forEach(d => {
                        const r = {id: d.id, ...d.data()};
                        allRecipes.push(r);
                        const rImg = r.img || r.image || 'https://via.placeholder.com/300x200?text=No+Image';
                        l.innerHTML += `<div class="recipe-card" onclick="app.openRecipeDetail('${r.id}')"><div class="recipe-img" style="background-image:url('${rImg}')"></div><div style="padding:15px;"><strong style="font-size:16px; color:var(--text-main);">${r.title}</strong><div class="recipe-meta" style="margin-top:5px; color:var(--primary);">${r.kcal} kcal | ${r.time} min</div></div></div>`;
                    });
                });
            },
            openRecipeDetail: (id) => {
                const r = allRecipes.find(x => x.id === id);
                if(!r) return;
                const rImg = r.img || r.image || 'https://via.placeholder.com/300x200?text=No+Image';
                document.getElementById('rec-det-img').style.backgroundImage = `url('${rImg}')`;
                document.getElementById('rec-det-title').innerText = r.title;
                document.getElementById('rec-det-meta').innerText = `${r.kcal} kcal | ${r.time} min`;
                document.getElementById('rec-det-p').innerText = r.p || 0;
                document.getElementById('rec-det-c').innerText = r.c || 0;
                document.getElementById('rec-det-f').innerText = r.f || 0;
                const ul = document.getElementById('rec-det-ing'); ul.innerHTML = '';
                if(r.ingredients) (Array.isArray(r.ingredients) ? r.ingredients : r.ingredients.split('\n')).forEach(i => ul.innerHTML+=`<li>${i}</li>`);
                const st = document.getElementById('rec-det-steps'); st.innerHTML = '';
                if(r.steps) (Array.isArray(r.steps) ? r.steps : r.steps.split('\n')).forEach((s, i) => st.innerHTML+=`<p><strong>${i+1}.</strong> ${s}</p>`);
                document.getElementById('view-recipe-detail').classList.add('active');
            },
            closeRecipeDetail: () => {
                document.getElementById('view-recipe-detail').classList.remove('active');
            },
            loadNews: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_NEWS), (snap) => {
                    const feed = document.getElementById('news-feed'); feed.innerHTML = '';
                    const news = []; snap.forEach(d => news.push(d.data())); news.sort((a,b) => b.created - a.created);
                    news.forEach(n => { 
                        feed.innerHTML += `
                        <div class="card news-card">
                            ${n.img ? `<img src="${n.img}" class="news-img">` : ''}
                            <div class="news-content">
                                <div class="news-date">${new Date(n.created).toLocaleDateString()}</div>
                                <h3 class="news-title">${n.title}</h3>
                                <div class="news-body" style="font-size:15px; line-height:1.6; color:var(--text-main);">${n.body}</div>
                            </div>
                        </div>`; 
                    });
                });
            },

            // ADMIN LOGIC
            showAdminAuth: () => document.getElementById('modal-admin-auth').classList.add('active'),
            checkAdminAuth: () => {
                if(document.getElementById('admin-pass-input').value === 'admin123') { document.getElementById('modal-admin-auth').classList.remove('active'); app.loadAdmin(); } 
                else { app.toast('Senha incorreta'); }
            },
            closeAdmin: () => app.screen('view-landing'),
            loadAdmin: () => { document.getElementById('view-admin').classList.add('active'); app.admTab('users'); },
            admTab: (t) => {
                document.querySelectorAll('[id^="adm-content"]').forEach(e=>e.classList.add('hidden'));
                document.getElementById('adm-content-'+t).classList.remove('hidden');
                document.querySelectorAll('.admin-tab-btn').forEach(b=>b.classList.remove('active'));
                document.getElementById('btn-adm-'+t).classList.add('active');
                if(t === 'users') app.admLoadUsers();
                if(t === 'news') app.admLoadNewsHistory();
                if(t === 'recipes') app.admLoadRecipes();
                if(t === 'quotes') app.admLoadQuotes();
                if(t === 'templates') app.admLoadTemplates();
            },
            
            // --- NOVO: ADMIN ACORDEÃO PARA USUÁRIOS ---
            admLoadUsers: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_USERS), (snap) => {
                    const list = document.getElementById('adm-users-list'); 
                    
                    let html = '';
                    snap.forEach(d => {
                        const u = d.data(); 
                        const docId = d.id;
                        const safeId = app.escape(docId); // ESCAPE DO ID PARA EVITAR ERROS DE SINTAXE
                        const isUserOpen = expandedUsers.has(docId) ? 'open' : '';
                        const checked = u.active ? 'checked' : '';
                        
                        let goalsHtml = '';
                        if(u.races && u.races.length > 0) {
                            u.races.forEach((r, rIdx) => {
                                const raceKey = `${docId}-${rIdx}`;
                                const isRaceOpen = expandedRaces.has(raceKey) ? 'open' : '';
                                
                                let workoutsHtml = '';
                                if(r.workouts && r.workouts.length > 0) {
                                    r.workouts.forEach((w, wIdx) => {
                                        // Exibir data agendada se existir
                                        let wDate = "";
                                        if(w.scheduledDate) {
                                            const dp = w.scheduledDate.split('-');
                                            wDate = `<span style="font-size:10px; color:#666; background:#eee; padding:2px 5px; border-radius:4px;">${dp[2]}/${dp[1]}</span>`;
                                        }
                                        
                                        workoutsHtml += `
                                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:5px 0;">
                                            <span style="font-size:12px;">${wDate} ${w.title}</span>
                                            <button onclick="app.admDeleteWorkoutInline('${safeId}', ${rIdx}, ${wIdx})" style="color:var(--red); border:none; background:none; cursor:pointer;"><i class="fa-solid fa-times"></i></button>
                                        </div>`;
                                    });
                                } else {
                                    workoutsHtml = '<p style="font-size:11px; color:#999;">Sem treinos.</p>';
                                }

                                // Botões de ação no fim da lista de treinos
                                workoutsHtml += `
                                <div style="display:flex; gap:5px; margin-top:10px; justify-content:flex-end;">
                                    <button onclick="app.admAddWorkoutInline('${safeId}', ${rIdx}')" class="adm-btn-small" style="background:#f0f0f0;">+ Treino</button>
                                    <button onclick="app.admImportTemplateInline('${safeId}', ${rIdx})" class="adm-btn-small" style="background:#f0f0f0;">+ Modelo</button>
                                </div>`;

                                goalsHtml += `
                                <div class="adm-item-box">
                                    <div class="adm-row-header" onclick="app.admToggleGoal('${raceKey}')">
                                        <strong>${r.name}</strong>
                                        <i class="fa-solid fa-chevron-down" style="font-size:12px; opacity:0.5;"></i>
                                    </div>
                                    <div id="goal-content-${raceKey}" class="adm-nested ${isRaceOpen}">
                                        ${workoutsHtml}
                                        <div style="text-align:right; margin-top:5px;">
                                            <button onclick="app.admDelRaceInline('${safeId}', ${rIdx})" style="font-size:10px; color:red; border:none; background:none; cursor:pointer;">Excluir Objetivo</button>
                                        </div>
                                    </div>
                                </div>`;
                            });
                        } else {
                            goalsHtml = '<p style="font-size:12px; color:#999; padding:10px;">Sem objetivos cadastrados.</p>';
                        }

                        html += `
                        <div class="card" style="padding:15px; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:15px; padding-bottom:5px;">
                                <input type="checkbox" class="check-toggle" ${checked} onchange="app.admToggleStatus('${safeId}', this.checked)">
                                <div style="flex:1; cursor:pointer;" onclick="app.admToggleUser('${safeId}')">
                                    <span style="font-weight:700; font-size:16px;">${u.name}</span>
                                    <br><span style="font-size:12px; color:#888;">${u.email}</span>
                                </div>
                                <button onclick="app.admDeleteUserQuick('${safeId}')" style="border:none; background:none; color:var(--red); cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <div id="user-content-${docId}" class="adm-nested ${isUserOpen}" style="border-left:none; padding-left:0; margin-top:15px;">
                                ${goalsHtml}
                                <button onclick="app.admAddRaceInline('${safeId}')" style="width:100%; border:2px dashed #eee; background:none; padding:12px; font-size:13px; margin-top:10px; color:var(--primary); font-weight:600; border-radius:12px; cursor:pointer;">+ Novo Objetivo</button>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
            },
            
            admToggleUser: (docId) => {
                if(expandedUsers.has(docId)) expandedUsers.delete(docId);
                else expandedUsers.add(docId);
                const el = document.getElementById(`user-content-${docId}`);
                if(el) el.classList.toggle('open');
            },
            admToggleGoal: (key) => {
                if(expandedRaces.has(key)) expandedRaces.delete(key);
                else expandedRaces.add(key);
                const el = document.getElementById(`goal-content-${key}`);
                if(el) el.classList.toggle('open');
            },
            
            admToggleStatus: async (docId, status) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId), { active: status });
                app.toast(status ? "Aluno aprovado" : "Aluno bloqueado");
            },
            
            // INLINE ACTIONS REFACTORED
            admAddWorkoutInline: (docId, rIdx) => {
                currentAdmUser = docId;
                currentAdmRaceIdx = rIdx;
                isEditingTemplate = false; 
                editingWorkoutIndex = null; // Reset
                document.getElementById('modal-workout-title').innerText = "Novo Treino";
                document.getElementById('new-w-title').value = '';
                document.getElementById('new-w-desc').value = '';
                document.getElementById('new-w-video').value = '';
                document.getElementById('modal-add-single-workout').classList.add('active');
            },
            
            saveSingleWorkout: async () => {
                const title = document.getElementById('new-w-title').value;
                const desc = document.getElementById('new-w-desc').value;
                const video = document.getElementById('new-w-video').value;
                if(!title) return app.toast('Título obrigatório');
                
                try {
                    if (isEditingTemplate) {
                        // ---- MODELOS ----
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, currentTemplateId));
                        const t = snap.data();
                        
                        if (editingWorkoutIndex !== null) {
                            // EDITAR existente
                            t.workouts[editingWorkoutIndex] = { title, desc, video, done: false };
                            app.toast("Treino atualizado");
                        } else {
                            // CRIAR novo
                            t.workouts.push({ title, desc, video, done: false });
                            app.toast("Treino adicionado ao modelo");
                        }
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, currentTemplateId), { workouts: t.workouts });
                        
                    } else {
                        // ---- ALUNOS ----
                        if (!currentAdmUser || currentAdmRaceIdx === null) throw new Error("Erro de referência do usuário.");
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentAdmUser));
                        if (!snap.exists()) throw new Error("Usuário não encontrado.");

                        const u = snap.data();
                        if (!u.races[currentAdmRaceIdx].workouts) u.races[currentAdmRaceIdx].workouts = [];

                        u.races[currentAdmRaceIdx].workouts.push({title, desc, video, done:false});
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentAdmUser), { races: u.races });
                        app.toast("Treino adicionado ao aluno");
                    }
                    document.getElementById('modal-add-single-workout').classList.remove('active');
                } catch(e) {
                    console.error(e);
                    app.toast("Erro ao salvar treino: " + e.message);
                }
            },

            admImportTemplateInline: (docId, rIdx) => {
                currentAdmUser = docId;
                currentAdmRaceIdx = rIdx;
                
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES), (s) => {
                    const list = document.getElementById('template-select-list');
                    list.innerHTML = '';
                    if(s.empty) { list.innerHTML = '<p>Nenhum modelo cadastrado.</p>'; return; }
                    
                    s.forEach(d => {
                        const t = d.data();
                        list.innerHTML += `
                        <label style="display:flex; align-items:center; padding:10px; border-bottom:1px solid #eee; cursor:pointer;">
                            <input type="radio" name="selected_template" value="${d.id}" style="margin-right:15px; width:18px; height:18px;">
                            <div>
                                <strong style="font-size:16px;">${t.name}</strong><br>
                                <span style="font-size:12px; color:#888;">${t.workouts.length} treinos</span>
                            </div>
                        </label>`;
                    });
                    document.getElementById('modal-select-template').classList.add('active');
                });
            },
            
            confirmTemplateImport: async () => {
                const selected = document.querySelector('input[name="selected_template"]:checked');
                const startDateInput = document.getElementById('template-start-date').value;
                
                if(!selected) return app.toast('Selecione um modelo');
                if(!startDateInput) return app.toast('Selecione a data de início');
                
                const templateId = selected.value;
                const tSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, templateId));
                const tData = tSnap.data();
                
                const uSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentAdmUser));
                const u = uSnap.data();
                
                // LÓGICA DE DATA SEQUENCIAL
                const startDate = new Date(startDateInput);
                const newWorkouts = tData.workouts.map((w, index) => {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + index);
                    return {
                        ...w,
                        scheduledDate: date.toISOString().split('T')[0],
                        done: false
                    };
                });
                
                u.races[currentAdmRaceIdx].workouts.push(...newWorkouts);
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, currentAdmUser), { races: u.races });
                app.toast("Modelo importado com datas!");
                document.getElementById('modal-select-template').classList.remove('active');
            },

            admDeleteWorkoutInline: async (docId, rIdx, wIdx) => {
                app.showConfirm("Remover este treino?", async () => {
                    try {
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId));
                        const u = snap.data();
                        u.races[rIdx].workouts.splice(wIdx, 1);
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId), { races: u.races });
                        app.toast("Treino removido.");
                    } catch(e) {
                        app.toast("Erro ao remover treino.");
                    }
                });
            },
            admAddRaceInline: async (docId) => {
                app.showPrompt("Nome do Objetivo:", async (name) => {
                    if(!name) return;
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId));
                    const u = snap.data();
                    const races = u.races || [];
                    races.push({ name, date: '', workouts: [], created: new Date().toISOString() });
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId), { races });
                    app.toast("Objetivo criado");
                });
            },
            admDelRaceInline: async (docId, rIdx) => {
                app.showConfirm("Apagar objetivo e seus treinos?", async () => {
                    try {
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId));
                        const u = snap.data();
                        u.races.splice(rIdx, 1);
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId), { races: u.races });
                        app.toast("Objetivo removido.");
                    } catch(e) {
                        app.toast("Erro ao remover objetivo.");
                    }
                });
            },
            
            admDeleteUserQuick: async (docId) => {
                app.showConfirm(`Apagar permanentemente?`, async () => {
                     await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_USERS, docId));
                     app.toast("Aluno excluído.");
                });
            },

            admAddRace: async () => {
                // ... fallback
            },

            admInsertRace: async (name, workouts) => {
                // ... legacy
            },

            admDelRace: async (idx) => {
                // ... legacy
            },
            
            // --- ADMIN TEMPLATES REFATORADO (ACORDEÃO + EDIÇÃO + REORDENAÇÃO) ---
            admLoadTemplates: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES), (snap) => {
                    const list = document.getElementById('adm-templates-list'); list.innerHTML = '';
                    
                    if (snap.empty) {
                        list.innerHTML = '<p style="text-align:center; color:#999;">Nenhum modelo criado.</p>';
                        return;
                    }

                    let html = '';
                    snap.forEach(d => {
                        const t = d.data();
                        const tId = d.id;
                        const isTplOpen = expandedTemplates.has(tId) ? 'open' : '';

                        let workoutsHtml = '';
                        if(t.workouts && t.workouts.length > 0) {
                            t.workouts.forEach((w, wIdx) => {
                                // Botões de controle de ordem
                                const upDisabled = wIdx === 0 ? 'opacity:0.3;' : '';
                                const downDisabled = wIdx === t.workouts.length - 1 ? 'opacity:0.3;' : '';
                                const safeVideo = w.video ? app.escape(w.video) : '';

                                workoutsHtml += `
                                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:8px 0;">
                                    <div style="flex:1;">
                                        <span style="font-size:13px; font-weight:600; color:var(--text-main);">${w.title}</span><br>
                                        <span style="font-size:11px; color:#666;">${w.desc}</span>
                                        ${safeVideo ? '<i class="fa-solid fa-video" style="font-size:10px; margin-left:5px; color:blue;"></i>' : ''}
                                    </div>
                                    <div style="display:flex; gap:5px;">
                                        <!-- REORDENAÇÃO -->
                                        <button onclick="app.admMoveWorkout('${tId}', ${wIdx}, -1)" style="border:1px solid #ddd; background:none; padding:2px 6px; ${upDisabled}"><i class="fa-solid fa-arrow-up"></i></button>
                                        <button onclick="app.admMoveWorkout('${tId}', ${wIdx}, 1)" style="border:1px solid #ddd; background:none; padding:2px 6px; ${downDisabled}"><i class="fa-solid fa-arrow-down"></i></button>
                                        
                                        <!-- EDIÇÃO -->
                                        <button onclick="app.admEditWorkoutFromTemplate('${tId}', ${wIdx})" style="border:1px solid #ddd; background:none; padding:2px 6px;"><i class="fa-solid fa-pencil"></i></button>
                                        
                                        <!-- EXCLUSÃO -->
                                        <button onclick="app.admDeleteWorkoutFromTemplate('${tId}', ${wIdx})" style="color:var(--red); border:none; background:none; font-weight:bold; margin-left:5px;">X</button>
                                    </div>
                                </div>`;
                            });
                        } else {
                            workoutsHtml = '<p style="font-size:11px; color:#999;">Sem treinos neste modelo.</p>';
                        }

                        html += `
                        <div class="card" style="padding:10px; margin-bottom:10px;">
                            <div class="adm-row-header" onclick="app.admToggleTemplate('${tId}')">
                                <span style="font-weight:600; color:var(--text-main);">${t.name}</span>
                                <div>
                                    <span style="font-size:11px; color:#888; margin-right:10px;">${t.workouts.length} treinos</span>
                                    <i class="fa-solid fa-chevron-down" style="font-size:12px; opacity:0.5;"></i>
                                </div>
                            </div>
                            <div id="tpl-content-${tId}" class="adm-nested ${isTplOpen}">
                                ${workoutsHtml}
                                <div style="display:flex; gap:5px; margin-top:10px; justify-content:space-between;">
                                    <button onclick="app.admAddWorkoutToTemplateInline('${tId}')" class="adm-btn-small" style="background:#f0f0f0;">+ Treino</button>
                                    <button onclick="app.admDelTemplate('${tId}')" style="color:red; border:none; background:none; font-size:11px;">Excluir Modelo</button>
                                </div>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
            },

            admToggleTemplate: (tId) => {
                if(expandedTemplates.has(tId)) expandedTemplates.delete(tId);
                else expandedTemplates.add(tId);
                const el = document.getElementById(`tpl-content-${tId}`);
                if(el) el.classList.toggle('open');
            },

            admAddTemplateInline: async () => {
                app.showPrompt("Nome do Novo Modelo:", async (name) => {
                    if(!name) return;
                    await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES)), { name, workouts: [] });
                    app.toast("Modelo criado");
                });
            },

            // ABRIR MODAL PARA CRIAR NOVO TREINO NO MODELO
            admAddWorkoutToTemplateInline: (tId) => {
                isEditingTemplate = true;
                currentTemplateId = tId;
                editingWorkoutIndex = null; // Resetar índice para indicar CRIAÇÃO
                
                document.getElementById('modal-workout-title').innerText = "Novo Treino";
                document.getElementById('new-w-title').value = '';
                document.getElementById('new-w-desc').value = '';
                document.getElementById('new-w-video').value = '';
                document.getElementById('modal-add-single-workout').classList.add('active');
            },

            // ABRIR MODAL PARA EDITAR TREINO EXISTENTE NO MODELO
            admEditWorkoutFromTemplate: async (tId, wIdx) => {
                isEditingTemplate = true;
                currentTemplateId = tId;
                editingWorkoutIndex = wIdx; // Setar índice para indicar EDIÇÃO
                
                // Buscar dados atuais para preencher o modal
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, tId));
                const w = snap.data().workouts[wIdx];
                
                document.getElementById('modal-workout-title').innerText = "Editar Treino";
                document.getElementById('new-w-title').value = w.title;
                document.getElementById('new-w-desc').value = w.desc;
                document.getElementById('new-w-video').value = w.video || '';
                document.getElementById('modal-add-single-workout').classList.add('active');
            },
            
            // MOVER TREINO (REORDENAR)
            admMoveWorkout: async (tId, wIdx, direction) => {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, tId));
                const t = snap.data();
                const workouts = t.workouts;
                
                const newIdx = wIdx + direction;
                if (newIdx < 0 || newIdx >= workouts.length) return; // Limites
                
                // Swap
                const temp = workouts[wIdx];
                workouts[wIdx] = workouts[newIdx];
                workouts[newIdx] = temp;
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, tId), { workouts: workouts });
            },

            admDeleteWorkoutFromTemplate: async (tId, wIdx) => {
                if(!confirm("Remover treino do modelo?")) return;
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, tId));
                const t = snap.data();
                t.workouts.splice(wIdx, 1);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, tId), { workouts: t.workouts });
            },

            admDelTemplate: async (id) => {
                app.showConfirm("Apagar modelo?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_TEMPLATES, id)));
            },
            
            handleNewsImg: (input) => { app.processImage(input, (b64) => { tempImgBase64 = b64; const img = document.getElementById('news-preview'); img.src = b64; img.style.display = 'block'; }); },
            postNews: async () => {
                const title = document.getElementById('news-title').value; const body = document.getElementById('news-body').value;
                if(!title || !body) return app.toast('Preencha tudo');
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', C_POSTS)), { title, body, img: tempImgBase64, created: Date.now() });
                app.toast('Publicado!'); document.getElementById('news-title').value=''; document.getElementById('news-body').value=''; document.getElementById('news-preview').style.display='none'; tempImgBase64 = null; app.admLoadNewsHistory();
            },
            admLoadNewsHistory: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_NEWS), (snap) => {
                    const div = document.getElementById('adm-news-history'); div.innerHTML = '';
                    snap.forEach(d => { 
                        div.innerHTML += `
                        <div style="padding:10px; border-bottom:1px solid #CCC; display:flex; justify-content:space-between; align-items:center;">
                            <span>${d.data().title}</span>
                            <button onclick="app.admDeleteNews('${d.id}')" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">X</button>
                        </div>`; 
                    });
                });
            },
            admDeleteNews: async (id) => {
                if(confirm("Apagar esta notícia?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_NEWS, id));
                    app.toast("Notícia removida.");
                }
            },

            handleRecImg: (input) => { app.processImage(input, (b64) => { tempRecImg = b64; const img = document.getElementById('adm-rec-preview'); img.src = b64; img.style.display = 'block'; }); },
            postRecipe: async () => {
                const title = document.getElementById('adm-rec-title').value;
                const kcal = document.getElementById('adm-rec-kcal').value;
                const time = document.getElementById('adm-rec-time').value;
                const p = document.getElementById('adm-rec-p').value;
                const c = document.getElementById('adm-rec-c').value;
                const f = document.getElementById('adm-rec-f').value;
                const ing = document.getElementById('adm-rec-ing').value.split('\n');
                const steps = document.getElementById('adm-rec-steps').value.split('\n');
                
                if(!title || !tempRecImg) return app.toast('Titulo e Imagem obrigatorios');
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', C_RECIPES)), {
                    title, kcal, time, p, c, f, ingredients: ing, steps: steps, img: tempRecImg, created: Date.now()
                });
                app.toast('Receita Salva');
                app.admLoadRecipes();
            },
            admLoadRecipes: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_RECIPES), (s) => {
                    const l = document.getElementById('adm-recipes-list'); l.innerHTML = '';
                    s.forEach(d=>{ l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">${d.data().title} <button onclick="app.admDelRec('${d.id}')" style="color:red;float:right;border:none;">X</button></div>` });
                });
            },
            admDelRec: async (id) => { app.showConfirm('Apagar receita?', async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_RECIPES, id))); },

            postQuote: async () => {
                const text = document.getElementById('adm-quote-text').value;
                if(!text) return;
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', C_QUOTES)), { text, created: Date.now() });
                document.getElementById('adm-quote-text').value = '';
                app.admLoadQuotes();
            },
            admLoadQuotes: () => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', C_QUOTES), (s) => {
                    const l = document.getElementById('adm-quotes-list'); l.innerHTML = '';
                    s.forEach(d=>{ l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">"${d.data().text}" <button onclick="app.admDelQuote('${d.id}')" style="color:red;float:right;border:none;">X</button></div>` });
                });
            },
            admDelQuote: async (id) => { app.showConfirm('Apagar frase?', async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', C_QUOTES, id))); },

            processImage: (input, callback) => {
                if(input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            const max = 800; let w = img.width, h = img.height;
                            if(w>h) { if(w>max){h*=max/w; w=max;} } else { if(h>max){w*=max/h; h=max;} }
                            canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                            callback(canvas.toDataURL('image/jpeg', 0.8));
                        };
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
